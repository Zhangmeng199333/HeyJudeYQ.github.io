<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>20、axios的封装</title><meta name="description" content="呦呦鹿鸣，食野之苹"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="
axios 基于 promise 的 http 库 特性：拦截请求和响应、取消请求、转换 json、客户端防御 XSRF



当后端接口报了 500 错误时被 axios 拦截了但确并未返回一个 promise，导致业务代码中未捕获此错误。
所以记住：

在每个 promise 链条中必须返回 promise，否则调用结果可能和你预期不一样。

123456789101112service.interceptors.response.use(  (response) =&amp;gt; &amp;#123;    if (response.status === 200 &amp;amp;&amp;amp; response.data) &amp;#123;      return response.data;    &amp;#125; else &amp;.."><meta name="generator" content="Hexo 4.2.1"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Jude's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">20、axios的封装</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、axios-的安装"><span class="toc-text">1、axios 的安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、在-request-文件夹-http-js"><span class="toc-text">2、在 request 文件夹 http.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、环境的切换-请求超时-post-请求头设置"><span class="toc-text">3、环境的切换&#x2F;请求超时&#x2F;post 请求头设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、请求拦截-响应拦截"><span class="toc-text">4、请求拦截 响应拦截</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、get、post-请求的封装"><span class="toc-text">5、get、post 请求的封装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、axios-完整封装代码"><span class="toc-text">6、axios 完整封装代码:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7、token-失效及接口国际化"><span class="toc-text">7、token 失效及接口国际化</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/axios"><i class="tag post-item-tag">axios</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">20、axios的封装</h1><time class="has-text-grey" datetime="2020-04-23T12:00:00.000Z">2020-04-23</time><article class="mt-2 post-content"><blockquote>
<p>axios 基于 promise 的 http 库 特性：拦截请求和响应、取消请求、转换 json、客户端防御 XSRF</p>
</blockquote>
<a id="more"></a>

<p>当后端接口报了 500 错误时被 axios 拦截了但确并未返回一个 promise，导致业务代码中未捕获此错误。</p>
<p>所以记住：</p>
<blockquote>
<p>在每个 promise 链条中必须返回 promise，否则调用结果可能和你预期不一样。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js">service.interceptors.response.use(<br>  (response) =&gt; &#123;<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-number">200</span> &amp;&amp; response.data) &#123;<br>      <span class="hljs-keyword">return</span> response.data;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"请求失败"</span>));<br>    &#125;<br>  &#125;,<br>  (error) =&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(error);<br>  &#125;<br>);<br></code></pre></td></tr></table></figure>

<h3 id="1、axios-的安装"><a href="#1、axios-的安装" class="headerlink" title="1、axios 的安装"></a>1、axios 的安装</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">npm install axios<br></code></pre></td></tr></table></figure>

<h3 id="2、在-request-文件夹-http-js"><a href="#2、在-request-文件夹-http-js" class="headerlink" title="2、在 request 文件夹 http.js"></a>2、在 request 文件夹 http.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// http.js</span><br><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;<br><span class="hljs-keyword">import</span> QS <span class="hljs-keyword">from</span> <span class="hljs-string">"qs"</span>; <span class="hljs-comment">// 序列化post类型的数据</span><br><span class="hljs-keyword">import</span> &#123; Toast &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">"vant"</span>; <span class="hljs-comment">// 引入vant组件库的toast组件</span><br></code></pre></td></tr></table></figure>

<h3 id="3、环境的切换-请求超时-post-请求头设置"><a href="#3、环境的切换-请求超时-post-请求头设置" class="headerlink" title="3、环境的切换&#x2F;请求超时&#x2F;post 请求头设置"></a>3、环境的切换&#x2F;请求超时&#x2F;post 请求头设置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 环境的切换</span><br><span class="hljs-keyword">if</span> (process.env.NODE_ENV == <span class="hljs-string">"development"</span>) &#123;<br>  axios.defaults.baseURL = <span class="hljs-string">"https://www.baidu.com"</span>;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.env.NODE_ENV == <span class="hljs-string">"debug"</span>) &#123;<br>  axios.defaults.baseURL = <span class="hljs-string">"https://www.ceshi.com"</span>;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.env.NODE_ENV == <span class="hljs-string">"production"</span>) &#123;<br>  axios.defaults.baseURL = <span class="hljs-string">"https://www.production.com"</span>;<br>&#125;<br><br>axios.defaults.timeout = <span class="hljs-number">10000</span>;<br><br>axios.defaults.headers.post[<span class="hljs-string">"Content-Type"</span>] =<br>  <span class="hljs-string">"application/x-www-form-urlencoded;charset=UTF-8"</span>;<br></code></pre></td></tr></table></figure>

<h3 id="4、请求拦截-响应拦截"><a href="#4、请求拦截-响应拦截" class="headerlink" title="4、请求拦截 响应拦截"></a>4、请求拦截 响应拦截</h3><details>
<summary>点击展示代码</summary>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 先导入vuex,因为我们要使用到里面的状态对象</span><br><span class="hljs-comment">// vuex的路径根据自己的路径去写</span><br><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/index'</span>;<br><br><span class="hljs-comment">// 请求拦截器</span><br>axios.interceptors.request.use(<br>    config =&gt; &#123;<br>        <span class="hljs-comment">// 每次发送请求之前判断vuex中是否存在token</span><br>        <span class="hljs-comment">// 如果存在，则统一在http请求的header都加上token，这样后台根据token判断你的登录情况</span><br>        <span class="hljs-comment">// 即使本地存在token，也有可能token是过期的，所以在响应拦截器中要对返回状态进行判断</span><br>        <span class="hljs-keyword">const</span> token = store.state.token;<br>        token &amp;&amp; (config.headers.Authorization = token);<br>        <span class="hljs-keyword">return</span> config;<br>    &#125;,<br>    error =&gt; &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.error(error);<br>    &#125;<br>)<br><br><span class="hljs-comment">// 响应拦截器</span><br>axios.interceptors.response.use(<br>    response =&gt; &#123;<br>        <span class="hljs-comment">// 如果返回的状态码为200，说明接口请求成功，可以正常拿到数据</span><br>        <span class="hljs-comment">// 否则的话抛出错误</span><br>        <span class="hljs-keyword">if</span> (response.status === <span class="hljs-number">200</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(response);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(response);<br>        &#125;<br>    &#125;,<br>    <span class="hljs-comment">// 服务器状态码不是2开头的的情况</span><br>    <span class="hljs-comment">// 这里可以跟你们的后台开发人员协商好统一的错误状态码</span><br>    <span class="hljs-comment">// 然后根据返回的状态码进行一些操作，例如登录过期提示，错误提示等等</span><br>    <span class="hljs-comment">// 下面列举几个常见的操作，其他需求可自行扩展</span><br>    error =&gt; &#123;<br>        <span class="hljs-keyword">if</span> (error.response.status) &#123;<br>            <span class="hljs-keyword">switch</span> (error.response.status) &#123;<br>                <span class="hljs-comment">// 401: 未登录</span><br>                <span class="hljs-comment">// 未登录则跳转登录页面，并携带当前页面的路径</span><br>                <span class="hljs-comment">// 在登录成功后返回当前页面，这一步需要在登录页操作。</span><br>                <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:<br>                    router.replace(&#123;<br>                        path: <span class="hljs-string">'/login'</span>,<br>                        query: &#123;<br>                            redirect: router.currentRoute.fullPath<br>                        &#125;<br>                    &#125;);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-comment">// 403 token过期</span><br>                <span class="hljs-comment">// 登录过期对用户进行提示</span><br>                <span class="hljs-comment">// 清除本地token和清空vuex中token对象</span><br>                <span class="hljs-comment">// 跳转登录页面</span><br>                <span class="hljs-keyword">case</span> <span class="hljs-number">403</span>:<br>                     Toast(&#123;<br>                        message: <span class="hljs-string">'登录过期，请重新登录'</span>,<br>                        duration: <span class="hljs-number">1000</span>,<br>                        forbidClick: <span class="hljs-literal">true</span><br>                    &#125;);<br>                    <span class="hljs-comment">// 清除token</span><br>                    localStorage.removeItem(<span class="hljs-string">'token'</span>);<br>                    store.commit(<span class="hljs-string">'loginSuccess'</span>, <span class="hljs-literal">null</span>);<br>                    <span class="hljs-comment">// 跳转登录页面，并将要浏览的页面fullPath传过去，登录成功后跳转需要访问的页面</span><br>                    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>                        router.replace(&#123;<br>                            path: <span class="hljs-string">'/login'</span>,<br>                            query: &#123;<br>                                redirect: router.currentRoute.fullPath<br>                            &#125;<br>                        &#125;);<br>                    &#125;, <span class="hljs-number">1000</span>);<br>                    <span class="hljs-keyword">break</span>;<br><br>                <span class="hljs-comment">// 404请求不存在</span><br>                <span class="hljs-keyword">case</span> <span class="hljs-number">404</span>:<br>                    Toast(&#123;<br>                        message: <span class="hljs-string">'网络请求不存在'</span>,<br>                        duration: <span class="hljs-number">1500</span>,<br>                        forbidClick: <span class="hljs-literal">true</span><br>                    &#125;);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-comment">// 其他错误，直接抛出错误提示</span><br>                <span class="hljs-keyword">default</span>:<br>                    Toast(&#123;<br>                        message: error.response.data.message,<br>                        duration: <span class="hljs-number">1500</span>,<br>                        forbidClick: <span class="hljs-literal">true</span><br>                    &#125;);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(error.response);<br>        &#125;<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

</details>

<h3 id="5、get、post-请求的封装"><a href="#5、get、post-请求的封装" class="headerlink" title="5、get、post 请求的封装"></a>5、get、post 请求的封装</h3><blockquote>
<p>get 方法：我们通过定义一个 get 函数，get 函数有两个参数，第一个参数表示我们要请求的 url 地址，第二个参数是我们要携带的请求参数。get 函数返回一个 promise 对象，当 axios 其请求成功时 resolve 服务器返回 值，请求失败时 reject 错误值。最后通过 export 抛出 get 函数。</p>
</blockquote>
<details>
<summary>点击展示代码</summary>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * get方法，对应get请求</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;String&#125;</span> </span>url [请求的url地址]</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;Object&#125;</span> </span>params [请求时携带的参数]</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params">url, params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    axios<br>      .get(url, &#123;<br>        params: params,<br>      &#125;)<br>      .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>        resolve(res.data);<br>      &#125;)<br>      .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>        reject(err.data);<br>      &#125;);<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

</details>

<blockquote>
<p>原理同 get 基本一样，但是要注意的是，post 方法必须要使用对提交从参数对象进行序列化的操作，所以这里我们通过 node 的 qs 模块来序列化我们的参数。这个很重要，如果没有序列化操作，后台是拿不到你提交的数据的。这就是文章开头我们 import QS from ‘qs’;的原因</p>
</blockquote>
<details>
<summary>点击展示代码</summary>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * post方法，对应post请求</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;String&#125;</span> </span>url [请求的url地址]</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;Object&#125;</span> </span>params [请求时携带的参数]</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">post</span>(<span class="hljs-params">url, params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    axios<br>      .post(url, QS.stringify(params))<br>      .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>        resolve(res.data);<br>      &#125;)<br>      .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>        reject(err.data);<br>      &#125;);<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

</details>

<h3 id="6、axios-完整封装代码"><a href="#6、axios-完整封装代码" class="headerlink" title="6、axios 完整封装代码:"></a>6、axios 完整封装代码:</h3><details>
<summary>点击展示代码</summary>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * axios封装</span><br><span class="hljs-comment"> * 请求拦截、响应拦截、错误统一处理</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;<br><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">"../router"</span>;<br><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">"../store/index"</span>;<br><span class="hljs-keyword">import</span> &#123; Toast &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">"vant"</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 提示函数</span><br><span class="hljs-comment"> * 禁止点击蒙层、显示一秒后关闭</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">const</span> tip = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> &#123;<br>  Toast(&#123;<br>    message: msg,<br>    duration: <span class="hljs-number">1000</span>,<br>    forbidClick: <span class="hljs-literal">true</span>,<br>  &#125;);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 跳转登录页</span><br><span class="hljs-comment"> * 携带当前页面路由，以期在登录页面完成登录后返回当前页面</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">const</span> toLogin = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  router.replace(&#123;<br>    path: <span class="hljs-string">"/login"</span>,<br>    query: &#123;<br>      redirect: router.currentRoute.fullPath,<br>    &#125;,<br>  &#125;);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 请求失败后的错误统一处理</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;Number&#125;</span> </span>status 请求失败的状态码</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">const</span> errorHandle = <span class="hljs-function">(<span class="hljs-params">status, other</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// 状态码判断</span><br>  <span class="hljs-keyword">switch</span> (status) &#123;<br>    <span class="hljs-comment">// 401: 未登录状态，跳转登录页</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:<br>      toLogin();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-comment">// 403 token过期</span><br>    <span class="hljs-comment">// 清除token并跳转登录页</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-number">403</span>:<br>      tip(<span class="hljs-string">"登录过期，请重新登录"</span>);<br>      localStorage.removeItem(<span class="hljs-string">"token"</span>);<br>      store.commit(<span class="hljs-string">"loginSuccess"</span>, <span class="hljs-literal">null</span>);<br>      setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>        toLogin();<br>      &#125;, <span class="hljs-number">1000</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-comment">// 404请求不存在</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-number">404</span>:<br>      tip(<span class="hljs-string">"请求的资源不存在"</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-built_in">console</span>.log(other);<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// 创建axios实例</span><br><span class="hljs-keyword">var</span> instance = axios.create(&#123; <span class="hljs-attr">timeout</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">12</span> &#125;);<br><span class="hljs-comment">// 设置post请求头</span><br>instance.defaults.headers.post[<span class="hljs-string">"Content-Type"</span>] =<br>  <span class="hljs-string">"application/x-www-form-urlencoded"</span>;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 请求拦截器</span><br><span class="hljs-comment"> * 每次请求前，如果存在token则在请求头中携带token</span><br><span class="hljs-comment"> */</span><br>instance.interceptors.request.use(<br>  (config) =&gt; &#123;<br>    <span class="hljs-comment">// 登录流程控制中，根据本地是否存在token判断用户的登录情况</span><br>    <span class="hljs-comment">// 但是即使token存在，也有可能token是过期的，所以在每次的请求头中携带token</span><br>    <span class="hljs-comment">// 后台根据携带的token判断用户的登录情况，并返回给我们对应的状态码</span><br>    <span class="hljs-comment">// 而后我们可以在响应拦截器中，根据状态码进行一些统一的操作。</span><br>    <span class="hljs-keyword">const</span> token = store.state.token;<br>    token &amp;&amp; (config.headers.Authorization = token);<br>    <span class="hljs-keyword">return</span> config;<br>  &#125;,<br>  (error) =&gt; <span class="hljs-built_in">Promise</span>.error(error)<br>);<br><br><span class="hljs-comment">// 响应拦截器</span><br>instance.interceptors.response.use(<br>  <span class="hljs-comment">// 请求成功</span><br>  (res) =&gt; (res.status === <span class="hljs-number">200</span> ? <span class="hljs-built_in">Promise</span>.resolve(res) : <span class="hljs-built_in">Promise</span>.reject(res)),<br>  <span class="hljs-comment">// 请求失败</span><br>  (error) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> &#123; response &#125; = error;<br>    <span class="hljs-keyword">if</span> (response) &#123;<br>      <span class="hljs-comment">// 请求已发出，但是不在2xx的范围</span><br>      errorHandle(response.status, response.data.message);<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(response);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 处理断网的情况</span><br>      <span class="hljs-comment">// eg:请求超时或断网时，更新state的network状态</span><br>      <span class="hljs-comment">// network状态在app.vue中控制着一个全局的断网提示组件的显示隐藏</span><br>      <span class="hljs-comment">// 关于断网组件中的刷新重新获取数据，会在断网组件中说明</span><br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">window</span>.navigator.onLine) &#123;<br>        store.commit(<span class="hljs-string">"changeNetwork"</span>, <span class="hljs-literal">false</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(error);<br>      &#125;<br>    &#125;<br>  &#125;<br>);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> instance;<br></code></pre></td></tr></table></figure>

</details>

<h3 id="7、token-失效及接口国际化"><a href="#7、token-失效及接口国际化" class="headerlink" title="7、token 失效及接口国际化"></a>7、token 失效及接口国际化</h3><details>
<summary>点击展示代码</summary>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 是否超时</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isCheckTimeout</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-comment">// 当前时间戳</span><br>  <span class="hljs-keyword">var</span> currentTime = <span class="hljs-built_in">Date</span>.now();<br>  <span class="hljs-comment">// 缓存时间戳</span><br>  <span class="hljs-keyword">var</span> timeStamp = getTimeStamp();<br>  <span class="hljs-keyword">return</span> currentTime - timeStamp &gt; TOKEN_TIMEOUT_VALUE;<br>&#125;<br><br><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;<br><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">"@/store"</span>;<br><span class="hljs-keyword">import</span> &#123; ElMessage &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">"element-plus"</span>;<br><span class="hljs-keyword">import</span> &#123; isCheckTimeout &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/auth"</span>;<br><br><span class="hljs-keyword">const</span> service = axios.create(&#123;<br>  baseURL: process.env.VUE_APP_BASE_API,<br>  timeout: <span class="hljs-number">5000</span>,<br>&#125;);<br><br><span class="hljs-comment">// 请求拦截器</span><br>service.interceptors.request.use(<br>  (config) =&gt; &#123;<br>    <span class="hljs-comment">// 在这个位置需要统一的去注入token</span><br>    <span class="hljs-keyword">if</span> (store.getters.token) &#123;<br>      <span class="hljs-keyword">if</span> (isCheckTimeout()) &#123;<br>        <span class="hljs-comment">// 登出操作</span><br>        store.dispatch(<span class="hljs-string">"user/logout"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"token 失效"</span>));<br>      &#125;<br>      <span class="hljs-comment">// 如果token存在 注入token</span><br>      config.headers.Authorization = <span class="hljs-string">`Bearer <span class="hljs-subst">$&#123;store.getters.token&#125;</span>`</span>;<br>    &#125;<br>    <span class="hljs-comment">// 配置接口国际化</span><br>    config.headers[<span class="hljs-string">"Accept-Language"</span>] = store.getters.language;<br>    <span class="hljs-keyword">return</span> config; <span class="hljs-comment">// 必须返回配置</span><br>  &#125;,<br>  (error) =&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(error);<br>  &#125;<br>);<br><br><span class="hljs-comment">// 响应拦截器</span><br>service.interceptors.response.use(<br>  (response) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> &#123; success, message, data &#125; = response.data;<br>    <span class="hljs-comment">//   要根据success的成功与否决定下面的操作</span><br>    <span class="hljs-keyword">if</span> (success) &#123;<br>      <span class="hljs-keyword">return</span> data;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 业务错误</span><br>      ElMessage.error(message); <span class="hljs-comment">// 提示错误消息</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(message));<br>    &#125;<br>  &#125;,<br>  (error) =&gt; &#123;<br>    <span class="hljs-comment">// 处理 token 超时问题</span><br>    <span class="hljs-keyword">if</span> (<br>      error.response &amp;&amp;<br>      error.response.data &amp;&amp;<br>      error.response.data.code === <span class="hljs-number">401</span><br>    ) &#123;<br>      <span class="hljs-comment">// token超时</span><br>      store.dispatch(<span class="hljs-string">"user/logout"</span>);<br>    &#125;<br>    ElMessage.error(error.message); <span class="hljs-comment">// 提示错误信息</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(error);<br>  &#125;<br>);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> service;<br></code></pre></td></tr></table></figure>

</details>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2020/04/28/21-v-charts/" title="21、v-charts的options"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: 21、v-charts的options</span></a><a class="button is-default" href="/2020/04/20/19-echarts/" title="19、关于echarts官方的一个bug -- sublink跳转问题"><span class="has-text-weight-semibold">下一页: 19、关于echarts官方的一个bug -- sublink跳转问题</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/Jude"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><a title="zhihu" target="_blank" rel="noopener nofollow" href="//zhihu.com/https://www.zhihu.com/hot"><i class="iconfont icon-zhihu"></i></a><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> Jude 2024</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" href="//github.com/haojen" target="_blank" rel="noopener">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" href="https://github.com/haojen/hexo-theme-Claudia" target="_blank" rel="noopener" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span>记住昨日的美好，过好今日的生活，憧憬明天的到来</span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>