<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>121、ProTable</title><meta name="description" content="呦呦鹿鸣，食野之苹"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="ProTable 是基于 Vue3.2 + Element-Plus 二次封装 el-table,首先我们在封装 ProTable 组件的时候，在不影响 el-table 原有的属性、事件、方法的前提下，然后在其基础上做二次封装。



ProTable 组件目前使用属性透传进行重构，支持 el-table &amp;amp;&amp;amp; el-table-column 所有属性、事件、方法的调用。ProTable 组件上的绑定的所有属性和事件都会通过 v-bind=&amp;quot;$attrs&amp;quot; 透传到 el-table 上。ProTable 组件内部暴露了 el-table DOM，可通过 proTable.value.element.方法名 调用其方法。

思路把一个表格页面所有重复的功能 （表格多选、查.."><meta name="generator" content="Hexo 7.0.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Jude's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">121、ProTable</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81ProTable-%E5%8A%9F%E8%83%BD"><span class="toc-text">一、ProTable 功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81ProTable-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">二、ProTable 需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E8%A1%A8%E6%A0%BC%E6%90%9C%E7%B4%A2%E5%8C%BA"><span class="toc-text">1、表格搜索区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%A1%A8%E6%A0%BC%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E6%8C%89%E9%92%AE"><span class="toc-text">2、表格数据操作按钮</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%A1%A8%E6%A0%BC%E5%8A%9F%E8%83%BD%E6%8C%89%E9%92%AE"><span class="toc-text">3、表格功能按钮</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E8%A1%A8%E6%A0%BC%E4%B8%BB%E4%BD%93%E5%86%85%E5%AE%B9%E5%B1%95%E7%A4%BA%E5%8C%BA%E5%9F%9F"><span class="toc-text">4、表格主体内容展示区域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E8%A1%A8%E6%A0%BC%E5%88%86%E9%A1%B5"><span class="toc-text">5、表格分页</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Hooks-%E5%87%BD%E6%95%B0"><span class="toc-text">三、Hooks 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81useTable"><span class="toc-text">1、useTable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81useSelection"><span class="toc-text">2、useSelection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81useDownload"><span class="toc-text">3、useDownload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81useHandledata"><span class="toc-text">4、useHandledata</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81ProTable-%E7%BB%84%E4%BB%B6%E9%83%A8%E5%88%86%E4%BB%A3%E7%A0%81"><span class="toc-text">四、ProTable 组件部分代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProTable-vue"><span class="toc-text">ProTable.vue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TableColumn-vue"><span class="toc-text">TableColumn.vue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ProTable-%E7%BB%84%E4%BB%B6"><span class="toc-text">使用 ProTable 组件</span></a></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/vue3"><i class="tag post-item-tag">vue3</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">121、ProTable</h1><time class="has-text-grey" datetime="2023-02-08T12:00:00.000Z">2023-02-08</time><article class="mt-2 post-content"><p>ProTable 是基于 Vue3.2 + Element-Plus 二次封装 el-table,首先我们在封装 ProTable 组件的时候，在不影响 el-table 原有的属性、事件、方法的前提下，然后在其基础上做二次封装。</p>
<span id="more"></span>

<blockquote>
<p><code>ProTable 组件目前使用属性透传进行重构，支持 el-table &amp;&amp; el-table-column 所有属性、事件、方法的调用。ProTable 组件上的绑定的所有属性和事件都会通过 v-bind=&quot;$attrs&quot; 透传到 el-table 上。ProTable 组件内部暴露了 el-table DOM，可通过 proTable.value.element.方法名 调用其方法。</code></p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>把一个表格页面所有重复的功能 （表格多选、查询、重置、刷新、分页、数据操作二次确认、文件下载、文件上传） 都封装成 Hooks 函数钩子或组件，然后在 ProTable 组件中使用这些函数钩子或组件。在页面中使用的时，只需传给 ProTable 当前表格数据的请求 API、表格配置项 columns 就行了，数据传输都使用 作用域插槽 或 tsx 语法从 ProTable 传递给父组件就能在页面上获取到了。</p>
<h2 id="一、ProTable-功能"><a href="#一、ProTable-功能" class="headerlink" title="一、ProTable 功能"></a>一、ProTable 功能</h2><p>1、表格内容自适应屏幕宽高，溢出内容表格内部滚动（flex 布局）<br>2、表格搜索、重置、分页查询 Hooks 封装 （页面使用不会存在任何搜索、重置、分页查询逻辑）<br>3、表格数据操作 Hooks 封装 （单条数据删除、批量删除、重置密码、状态切换等操作）<br>4、表格数据多选 Hooks 封装 （支持现跨页勾选数据）<br>5、表格数据导入组件、导出 Hooks 封装<br>6、表格搜索区域使用 Grid 布局重构，支持自定义响应式配置<br>7、表格分页组件封装（Pagination）<br>8、表格数据刷新、列显隐、列排序、搜索区域显隐设置<br>9、表格数据打印功能（可勾选行数据、隐藏列打印）<br>10、表格配置支持多级 prop（示例 &#x3D;&#x3D;&gt; prop: user.detail.name）<br>11、单元格内容格式化、tag 标签显示（有字典 enum 会根据字典 enum 自动格式化）<br>12、支持多级表头、表头内容自定义渲染（支持作用域插槽、tsx 语法、h 函数）<br>13、支持单元格内容自定义渲染（支持作用域插槽、tsx 语法、h 函数）<br>14、配合 TreeFilter、SelectFilter 组件使用更佳</p>
<h2 id="二、ProTable-需求分析"><a href="#二、ProTable-需求分析" class="headerlink" title="二、ProTable 需求分析"></a>二、ProTable 需求分析</h2><p>ProTable 主要分为五个模块：</p>
<h3 id="1、表格搜索区"><a href="#1、表格搜索区" class="headerlink" title="1、表格搜索区"></a>1、表格搜索区</h3><blockquote>
<p>搜索区域的字段都是存在于表格当中的，并且每个页面的搜索、重置方法都是一样的逻辑，只是不同的查询参数而已。我们完全可以在传表格配置项 columns 时，直接指定某个 column 的 search 配置，就能把该项变为搜索项，然后使用 el 字段可以指定搜索框的类型，最后把表格的搜索方法都封装成 Hooks 钩子函数。页面上完全就不会存在任何搜索、重置逻辑了。</p>
</blockquote>
<p>通过 component :is 动态组件 &amp;&amp; v-bind 属性透传实现，将用户传递的参数全部透传到组件上，所以可以直接根据 element 官方文档在 props 中传递参数了。</p>
<pre><code class="vue">&lt;template&gt;
  &lt;component
    :is=&quot;column.search?.render ?? `el-$&#123;column.search?.el&#125;`&quot;
    v-bind=&quot;&#123; ...handleSearchProps, ...placeholder, searchParam, clearable &#125;&quot;
    v-model.trim=&quot;searchParam[column.search?.key ?? handleProp(column.prop!)]&quot;
    :data=&quot;column.search?.el === &#39;tree-select&#39; ? columnEnum : []&quot;
    :options=&quot;[&#39;cascader&#39;, &#39;select-v2&#39;].includes(column.search?.el!) ? columnEnum : []&quot;
  &gt;
    &lt;template #default=&quot;&#123; data &#125;&quot; v-if=&quot;column.search?.el === &#39;cascader&#39;&quot;&gt;
      &lt;span&gt;&#123;&#123; data[fieldNames.label] &#125;&#125;&lt;/span&gt;
    &lt;/template&gt;
    &lt;template v-if=&quot;column.search?.el === &#39;select&#39;&quot;&gt;
      &lt;component
        :is=&quot;`el-option`&quot;
        v-for=&quot;(col, index) in columnEnum&quot;
        :key=&quot;index&quot;
        :label=&quot;col[fieldNames.label]&quot;
        :value=&quot;col[fieldNames.value]&quot;
      &gt;&lt;/component&gt;
    &lt;/template&gt;
    &lt;slot v-else&gt;&lt;/slot&gt;
  &lt;/component&gt;
&lt;/template&gt;

&lt;script setup lang=&quot;ts&quot; name=&quot;SearchFormItem&quot;&gt;
import &#123; computed, inject, ref &#125; from &quot;vue&quot;;
import &#123; handleProp &#125; from &quot;@/utils&quot;;
import &#123; ColumnProps &#125; from &quot;@/components/ProTable/interface&quot;;

interface SearchFormItem &#123;
  column: ColumnProps;
  searchParam: &#123; [key: string]: any &#125;;
&#125;
const props = defineProps&lt;SearchFormItem&gt;();

// 判断 fieldNames 设置 label &amp;&amp; value &amp;&amp; children 的 key 值
const fieldNames = computed(() =&gt; &#123;
  return &#123;
    label: props.column.fieldNames?.label ?? &quot;label&quot;,
    value: props.column.fieldNames?.value ?? &quot;value&quot;,
    children: props.column.fieldNames?.children ?? &quot;children&quot;,
  &#125;;
&#125;);

// 接收 enumMap (el 为 select-v2 需单独处理 enumData)
const enumMap = inject(&quot;enumMap&quot;, ref(new Map()));
const columnEnum = computed(() =&gt; &#123;
  let enumData = enumMap.value.get(props.column.prop);
  if (!enumData) return [];
  if (props.column.search?.el === &quot;select-v2&quot; &amp;&amp; props.column.fieldNames) &#123;
    enumData = enumData.map((item: &#123; [key: string]: any &#125;) =&gt; &#123;
      return &#123;
        ...item,
        label: item[fieldNames.value.label],
        value: item[fieldNames.value.value],
      &#125;;
    &#125;);
  &#125;
  return enumData;
&#125;);

// 处理透传的 searchProps (el 为 tree-select、cascader 的时候需要给下默认 label &amp;&amp; value &amp;&amp; children)
const handleSearchProps = computed(() =&gt; &#123;
  const label = fieldNames.value.label;
  const value = fieldNames.value.value;
  const children = fieldNames.value.children;
  const searchEl = props.column.search?.el;
  let searchProps = props.column.search?.props ?? &#123;&#125;;
  if (searchEl === &quot;tree-select&quot;) &#123;
    searchProps = &#123;
      ...searchProps,
      props: &#123; ...searchProps.props, label, children &#125;,
      nodeKey: value,
    &#125;;
  &#125;
  if (searchEl === &quot;cascader&quot;) &#123;
    searchProps = &#123;
      ...searchProps,
      props: &#123; ...searchProps.props, label, value, children &#125;,
    &#125;;
  &#125;
  return searchProps;
&#125;);

// 处理默认 placeholder
const placeholder = computed(() =&gt; &#123;
  const search = props.column.search;
  if (
    [&quot;datetimerange&quot;, &quot;daterange&quot;, &quot;monthrange&quot;].includes(
      search?.props?.type
    ) ||
    search?.props?.isRange
  ) &#123;
    return &#123;
      rangeSeparator: &quot;至&quot;,
      startPlaceholder: &quot;开始时间&quot;,
      endPlaceholder: &quot;结束时间&quot;,
    &#125;;
  &#125;
  const placeholder =
    search?.props?.placeholder ??
    (search?.el?.includes(&quot;input&quot;) ? &quot;请输入&quot; : &quot;请选择&quot;);
  return &#123; placeholder &#125;;
&#125;);

// 是否有清除按钮 (当搜索项有默认值时，清除按钮不显示)
const clearable = computed(() =&gt; &#123;
  const search = props.column.search;
  return (
    search?.props?.clearable ??
    (search?.defaultValue == null || search?.defaultValue == undefined)
  );
&#125;);
&lt;/script&gt;
</code></pre>
<p>表格搜索项可以使用 tsx 组件自定义渲染</p>
<pre><code class="vue">&lt;script setup lang=&quot;tsx&quot;&gt;
const columns: ColumnProps[] = [
  &#123;
    prop: &quot;user.detail.age&quot;,
    label: &quot;年龄&quot;,
    search: &#123;
      // 自定义 search 组件
      render: (&#123; searchParam &#125;) =&gt; &#123;
        return (
          &lt;div class=&quot;flx-center&quot;&gt;
            &lt;el-input
              vModel_trim=&#123;searchParam.minAge&#125;
              placeholder=&quot;最小年龄&quot;
              style=&#123;&#123; width: "50%" &#125;&#125;
            /&gt;
            &lt;span class=&quot;mr10 ml10&quot;&gt;-&lt;/span&gt;
            &lt;el-input
              vModel_trim=&#123;searchParam.maxAge&#125;
              placeholder=&quot;最大年龄&quot;
              style=&#123;&#123; width: "50%" &#125;&#125;
            /&gt;
          &lt;/div&gt;
        );
      &#125;,
    &#125;,
  &#125;,
];
&lt;/script&gt;
</code></pre>
<h3 id="2、表格数据操作按钮"><a href="#2、表格数据操作按钮" class="headerlink" title="2、表格数据操作按钮"></a>2、表格数据操作按钮</h3><blockquote>
<p>表格数据操作按钮基本上每个页面都会不一样，所以我们直接使用 作用域插槽 来完成每个页面的数据操作按钮区域，作用域插槽 可以将表格多选数据信息从 ProTable 的 Hooks 多选钩子函数中传到页面上使用。<br>scope 数据中包含：selectedList（当前选择的数据）、selectedListIds（当前选择的数据 id）、isSelected（当前是否选中的数据）</p>
</blockquote>
<pre><code class="vue">&lt;!-- ProTable 中 tableHeader 插槽 --&gt;
&lt;slot
  name=&quot;tableHeader&quot;
  :selectList=&quot;selectedList&quot;
  :selectedListIds=&quot;selectedListIds&quot;
  :isSelected=&quot;isSelected&quot;
&gt;&lt;/slot&gt;

&lt;!-- 页面使用 --&gt;
&lt;template #tableHeader=&quot;scope&quot;&gt;
  &lt;el-button type=&quot;primary&quot; :icon=&quot;CirclePlus&quot; @click=&quot;openDrawer(&#39;新增&#39;)&quot;
    &gt;新增用户&lt;/el-button
  &gt;
  &lt;el-button type=&quot;primary&quot; :icon=&quot;Upload&quot; plain @click=&quot;batchAdd&quot;
    &gt;批量添加用户&lt;/el-button
  &gt;
  &lt;el-button type=&quot;primary&quot; :icon=&quot;Download&quot; plain @click=&quot;downloadFile&quot;
    &gt;导出用户数据&lt;/el-button
  &gt;
  &lt;el-button
    type=&quot;danger&quot;
    :icon=&quot;Delete&quot;
    plain
    @click=&quot;batchDelete(scope.selectedListIds)&quot;
    :disabled=&quot;!scope.isSelected&quot;
    &gt;批量删除用户&lt;/el-button
  &gt;
&lt;/template&gt;
</code></pre>
<h3 id="3、表格功能按钮"><a href="#3、表格功能按钮" class="headerlink" title="3、表格功能按钮"></a>3、表格功能按钮</h3><blockquote>
<p>表格功能按钮包括：表格数据刷新（一直会携带当前查询和分页条件）、表格数据打印、表格列设置（列显隐、列排序）、表格搜索区域显隐（方便展示更多的数据信息）。 可通过 toolButton 属性控制这块区域的显隐。<br>表格打印基于 PrintJs 实现，因 PrintJs 不支持多级表头打印，所以当页面存在多级表头时，只会打印最后一级表头。表格打印功能可根据显示的列和勾选的数据动态打印，默认打印当前显示的所有数据。</p>
</blockquote>
<h3 id="4、表格主体内容展示区域"><a href="#4、表格主体内容展示区域" class="headerlink" title="4、表格主体内容展示区域"></a>4、表格主体内容展示区域</h3><p>这里是最重要的数据展示区域，表头和单元格内容可以自定义渲染，表头支持 headerRender 方法（避免与 el-table-column 上的属性重名导致报错）、作用域插槽（column.prop + ‘Header’）两种方式自定义，单元格内容支持 render 方法和作用域插槽（column 上的 prop 属性）两种方式自定义。</p>
<p>作用域插槽：</p>
<pre><code class="vue">&lt;!-- 使用作用域插槽自定义单元格内容 username --&gt;
&lt;template #username=&quot;scope&quot;&gt;
  &#123;&#123; scope.row.username &#125;&#125;
&lt;/template&gt;

&lt;!-- 使用作用域插槽自定义表头内容 username --&gt;
&lt;template #usernameHeader=&quot;scope&quot;&gt;
  &lt;el-button
    type=&quot;primary&quot;
    @click=&quot;ElMessage.success(&#39;我是通过作用域插槽渲染的表头&#39;)&quot;
  &gt;
    &#123;&#123; scope.column.label &#125;&#125;
  &lt;/el-button&gt;
&lt;/template&gt;
</code></pre>
<p>tsx 语法：</p>
<pre><code class="vue">&lt;script setup lang=&quot;tsx&quot;&gt;
const columns: ColumnProps[] = [
 &#123;
    prop: &quot;username&quot;,
    label: &quot;用户姓名&quot;,
    // 使用 headerRender 自定义表头
    headerRender: scope =&gt; &#123;
      return (
        &lt;el-button
          type=&quot;primary&quot;
          onClick=&#123;() =&gt; &#123;
            ElMessage.success(&quot;我是通过 tsx 语法渲染的表头&quot;);
          &#125;&#125;
        &gt;
          &#123;scope.column.label&#125;
        &lt;/el-button&gt;
      );
    &#125;
  &#125;,
  &#123;
    prop: &quot;status&quot;,
    label: &quot;用户状态&quot;,
    // 使用 render 自定义表格内容
    render: scope =&gt; &#123;
      return (
          &lt;el-switch
            model-value=&#123;scope.row.status&#125;
            active-text=&#123;scope.row.status ? &quot;启用&quot; : &quot;禁用&quot;&#125;
            active-value=&#123;1&#125;
            inactive-value=&#123;0&#125;
            onClick=&#123;() =&gt; changeStatus(scope.row)&#125;
          /&gt;
        )
      );
    &#125;
  &#125;,
];
&lt;/script&gt;
</code></pre>
<blockquote>
<p>如果你想使用 el-table 的任何属性、事件，目前通过属性透传都能支持。</p>
</blockquote>
<pre><code class="vue">&lt;template&gt;
  &lt;el-table ref=&quot;tableRef&quot; v-bind=&quot;$attrs&quot;&gt; &lt;/el-table&gt;
&lt;/template&gt;

&lt;script setup lang=&quot;ts&quot; name=&quot;ProTable&quot;&gt;
import &#123; ref &#125; from &quot;vue&quot;;
import &#123; ElTable &#125; from &quot;element-plus&quot;;

const tableRef = ref&lt;InstanceType&lt;typeof ElTable&gt;&gt;();

defineExpose(&#123; element: tableRef &#125;);
&lt;/script&gt;
</code></pre>
<h3 id="5、表格分页"><a href="#5、表格分页" class="headerlink" title="5、表格分页"></a>5、表格分页</h3><p>表格分页的封装可以使 ProTable 页面不存在分页逻辑。</p>
<pre><code class="vue">&lt;template&gt;
  &lt;!-- 分页组件 --&gt;
  &lt;el-pagination
    :background=&quot;true&quot;
    :current-page=&quot;pageable.pageNum&quot;
    :page-size=&quot;pageable.pageSize&quot;
    :page-sizes=&quot;[10, 25, 50, 100]&quot;
    :total=&quot;pageable.total&quot;
    layout=&quot;total, sizes, prev, pager, next, jumper&quot;
    @size-change=&quot;handleSizeChange&quot;
    @current-change=&quot;handleCurrentChange&quot;
  &gt;&lt;/el-pagination&gt;
&lt;/template&gt;

&lt;script setup lang=&quot;ts&quot; name=&quot;Pagination&quot;&gt;
interface Pageable &#123;
  pageNum: number;
  pageSize: number;
  total: number;
&#125;

interface PaginationProps &#123;
  pageable: Pageable;
  handleSizeChange: (size: number) =&gt; void;
  handleCurrentChange: (currentPage: number) =&gt; void;
&#125;

defineProps&lt;PaginationProps&gt;();
&lt;/script&gt;
</code></pre>
<h2 id="三、Hooks-函数"><a href="#三、Hooks-函数" class="headerlink" title="三、Hooks 函数"></a>三、Hooks 函数</h2><h3 id="1、useTable"><a href="#1、useTable" class="headerlink" title="1、useTable"></a>1、useTable</h3><pre><code class="ts">import &#123; Table &#125; from &quot;./interface&quot;;
import &#123; reactive, computed, toRefs &#125; from &quot;vue&quot;;

/**
 * @description table 页面操作方法封装
 * @param &#123;Function&#125; api 获取表格数据 api 方法 (必传)
 * @param &#123;Object&#125; initParam 获取数据初始化参数 (非必传，默认为&#123;&#125;)
 * @param &#123;Boolean&#125; isPageable 是否有分页 (非必传，默认为true)
 * @param &#123;Function&#125; dataCallBack 对后台返回的数据进行处理的方法 (非必传)
 * */
export const useTable = (
  api?: (params: any) =&gt; Promise&lt;any&gt;,
  initParam: object = &#123;&#125;,
  isPageable: boolean = true,
  dataCallBack?: (data: any) =&gt; any,
  requestError?: (error: any) =&gt; void
) =&gt; &#123;
  const state = reactive&lt;Table.TableStateProps&gt;(&#123;
    // 表格数据
    tableData: [],
    // 分页数据
    pageable: &#123;
      // 当前页数
      pageNum: 1,
      // 每页显示条数
      pageSize: 10,
      // 总条数
      total: 0,
    &#125;,
    // 查询参数(只包括查询)
    searchParam: &#123;&#125;,
    // 初始化默认的查询参数
    searchInitParam: &#123;&#125;,
    // 总参数(包含分页和查询参数)
    totalParam: &#123;&#125;,
  &#125;);

  /**
   * @description 分页查询参数(只包括分页和表格字段排序,其他排序方式可自行配置)
   * */
  const pageParam = computed(&#123;
    get: () =&gt; &#123;
      return &#123;
        pageNum: state.pageable.pageNum,
        pageSize: state.pageable.pageSize,
      &#125;;
    &#125;,
    set: (newVal: any) =&gt; &#123;
      console.log(&quot;我是分页更新之后的值&quot;, newVal);
    &#125;,
  &#125;);

  /**
   * @description 获取表格数据
   * @return void
   * */
  const getTableList = async () =&gt; &#123;
    if (!api) return;
    try &#123;
      // 先把初始化参数和分页参数放到总参数里面
      Object.assign(
        state.totalParam,
        initParam,
        isPageable ? pageParam.value : &#123;&#125;
      );
      let &#123; data &#125; = await api(&#123;
        ...state.searchInitParam,
        ...state.totalParam,
      &#125;);
      dataCallBack &amp;&amp; (data = dataCallBack(data));
      state.tableData = isPageable ? data.list : data;
      // 解构后台返回的分页数据 (如果有分页更新分页信息)
      const &#123; pageNum, pageSize, total &#125; = data;
      isPageable &amp;&amp; updatePageable(&#123; pageNum, pageSize, total &#125;);
    &#125; catch (error) &#123;
      requestError &amp;&amp; requestError(error);
    &#125;
  &#125;;

  /**
   * @description 更新查询参数
   * @return void
   * */
  const updatedTotalParam = () =&gt; &#123;
    state.totalParam = &#123;&#125;;
    // 处理查询参数，可以给查询参数加自定义前缀操作
    let nowSearchParam: &#123; [key: string]: any &#125; = &#123;&#125;;
    // 防止手动清空输入框携带参数（这里可以自定义查询参数前缀）
    for (let key in state.searchParam) &#123;
      // * 某些情况下参数为 false/0 也应该携带参数
      if (
        state.searchParam[key] ||
        state.searchParam[key] === false ||
        state.searchParam[key] === 0
      ) &#123;
        nowSearchParam[key] = state.searchParam[key];
      &#125;
    &#125;
    Object.assign(
      state.totalParam,
      nowSearchParam,
      isPageable ? pageParam.value : &#123;&#125;
    );
  &#125;;

  /**
   * @description 更新分页信息
   * @param &#123;Object&#125; resPageable 后台返回的分页数据
   * @return void
   * */
  const updatePageable = (resPageable: Table.Pageable) =&gt; &#123;
    Object.assign(state.pageable, resPageable);
  &#125;;

  /**
   * @description 表格数据查询
   * @return void
   * */
  const search = () =&gt; &#123;
    state.pageable.pageNum = 1;
    updatedTotalParam();
    getTableList();
  &#125;;

  /**
   * @description 表格数据重置
   * @return void
   * */
  const reset = () =&gt; &#123;
    state.pageable.pageNum = 1;
    state.searchParam = &#123;&#125;;
    // 重置搜索表单的时，如果有默认搜索参数，则重置默认的搜索参数
    Object.keys(state.searchInitParam).forEach((key) =&gt; &#123;
      state.searchParam[key] = state.searchInitParam[key];
    &#125;);
    updatedTotalParam();
    getTableList();
  &#125;;

  /**
   * @description 每页条数改变
   * @param &#123;Number&#125; val 当前条数
   * @return void
   * */
  const handleSizeChange = (val: number) =&gt; &#123;
    state.pageable.pageNum = 1;
    state.pageable.pageSize = val;
    getTableList();
  &#125;;

  /**
   * @description 当前页改变
   * @param &#123;Number&#125; val 当前页
   * @return void
   * */
  const handleCurrentChange = (val: number) =&gt; &#123;
    state.pageable.pageNum = val;
    getTableList();
  &#125;;

  return &#123;
    ...toRefs(state),
    getTableList,
    search,
    reset,
    handleSizeChange,
    handleCurrentChange,
    updatedTotalParam,
  &#125;;
&#125;;
</code></pre>
<h3 id="2、useSelection"><a href="#2、useSelection" class="headerlink" title="2、useSelection"></a>2、useSelection</h3><pre><code class="ts">import &#123; ref, computed &#125; from &quot;vue&quot;;

/**
 * @description 表格多选数据操作
 * @param &#123;String&#125; rowKey 当表格可以多选时，所指定的 id
 * */
export const useSelection = (rowKey: string = &quot;id&quot;) =&gt; &#123;
  const isSelected = ref&lt;boolean&gt;(false);
  const selectedList = ref&lt;&#123; [key: string]: any &#125;[]&gt;([]);

  // 当前选中的所有 ids 数组
  const selectedListIds = computed((): string[] =&gt; &#123;
    let ids: string[] = [];
    selectedList.value.forEach((item) =&gt; ids.push(item[rowKey]));
    return ids;
  &#125;);

  /**
   * @description 多选操作
   * @param &#123;Array&#125; rowArr 当前选择的所有数据
   * @return void
   */
  const selectionChange = (rowArr: &#123; [key: string]: any &#125;[]) =&gt; &#123;
    rowArr.length ? (isSelected.value = true) : (isSelected.value = false);
    selectedList.value = rowArr;
  &#125;;

  return &#123;
    isSelected,
    selectedList,
    selectedListIds,
    selectionChange,
  &#125;;
&#125;;
</code></pre>
<h3 id="3、useDownload"><a href="#3、useDownload" class="headerlink" title="3、useDownload"></a>3、useDownload</h3><pre><code class="ts">import &#123; ElNotification &#125; from &quot;element-plus&quot;;

/**
 * @description 接收数据流生成 blob，创建链接，下载文件
 * @param &#123;Function&#125; api 导出表格的api方法 (必传)
 * @param &#123;String&#125; tempName 导出的文件名 (必传)
 * @param &#123;Object&#125; params 导出的参数 (默认&#123;&#125;)
 * @param &#123;Boolean&#125; isNotify 是否有导出消息提示 (默认为 true)
 * @param &#123;String&#125; fileType 导出的文件格式 (默认为.xlsx)
 * */
export const useDownload = async (
  api: (param: any) =&gt; Promise&lt;any&gt;,
  tempName: string,
  params: any = &#123;&#125;,
  isNotify: boolean = true,
  fileType: string = &quot;.xlsx&quot;
) =&gt; &#123;
  if (isNotify) &#123;
    ElNotification(&#123;
      title: &quot;温馨提示&quot;,
      message: &quot;如果数据庞大会导致下载缓慢哦，请您耐心等待！&quot;,
      type: &quot;info&quot;,
      duration: 3000,
    &#125;);
  &#125;
  try &#123;
    const res = await api(params);
    const blob = new Blob([res]);
    // 兼容 edge 不支持 createObjectURL 方法
    if (&quot;msSaveOrOpenBlob&quot; in navigator)
      return window.navigator.msSaveOrOpenBlob(blob, tempName + fileType);
    const blobUrl = window.URL.createObjectURL(blob);
    const exportFile = document.createElement(&quot;a&quot;);
    exportFile.style.display = &quot;none&quot;;
    exportFile.download = `$&#123;tempName&#125;$&#123;fileType&#125;`;
    exportFile.href = blobUrl;
    document.body.appendChild(exportFile);
    exportFile.click();
    // 去除下载对 url 的影响
    document.body.removeChild(exportFile);
    window.URL.revokeObjectURL(blobUrl);
  &#125; catch (error) &#123;
    console.log(error);
  &#125;
&#125;;
</code></pre>
<h3 id="4、useHandledata"><a href="#4、useHandledata" class="headerlink" title="4、useHandledata"></a>4、useHandledata</h3><pre><code class="ts">import &#123; ElMessageBox, ElMessage &#125; from &quot;element-plus&quot;;
import &#123; HandleData &#125; from &quot;./interface&quot;;

/**
 * @description 操作单条数据信息 (二次确认【删除、禁用、启用、重置密码】)
 * @param &#123;Function&#125; api 操作数据接口的api方法 (必传)
 * @param &#123;Object&#125; params 携带的操作数据参数 &#123;id,params&#125; (必传)
 * @param &#123;String&#125; message 提示信息 (必传)
 * @param &#123;String&#125; confirmType icon类型 (不必传,默认为 warning)
 * @returns &#123;Promise&#125;
 */
export const useHandleData = (
  api: (params: any) =&gt; Promise&lt;any&gt;,
  params: any = &#123;&#125;,
  message: string,
  confirmType: HandleData.MessageType = &quot;warning&quot;
) =&gt; &#123;
  return new Promise((resolve, reject) =&gt; &#123;
    ElMessageBox.confirm(`是否$&#123;message&#125;?`, &quot;温馨提示&quot;, &#123;
      confirmButtonText: &quot;确定&quot;,
      cancelButtonText: &quot;取消&quot;,
      type: confirmType,
      draggable: true,
    &#125;).then(async () =&gt; &#123;
      const res = await api(params);
      if (!res) return reject(false);
      ElMessage(&#123;
        type: &quot;success&quot;,
        message: `$&#123;message&#125;成功!`,
      &#125;);
      resolve(true);
    &#125;);
  &#125;);
&#125;;
</code></pre>
<h2 id="四、ProTable-组件部分代码"><a href="#四、ProTable-组件部分代码" class="headerlink" title="四、ProTable 组件部分代码"></a>四、ProTable 组件部分代码</h2><h3 id="ProTable-vue"><a href="#ProTable-vue" class="headerlink" title="ProTable.vue"></a>ProTable.vue</h3><pre><code class="vue">&lt;template&gt;
  &lt;!-- 查询表单 card --&gt;
  &lt;SearchForm
    :search=&quot;search&quot;
    :reset=&quot;reset&quot;
    :columns=&quot;searchColumns&quot;
    :search-param=&quot;searchParam&quot;
    :search-col=&quot;searchCol&quot;
    v-show=&quot;isShowSearch&quot;
  /&gt;

  &lt;!-- 表格内容 card --&gt;
  &lt;div class=&quot;card table-main&quot;&gt;
    &lt;!-- 表格头部 操作按钮 --&gt;
    &lt;div class=&quot;table-header&quot;&gt;
      &lt;div class=&quot;header-button-lf&quot;&gt;
        &lt;slot
          name=&quot;tableHeader&quot;
          :selectedListIds=&quot;selectedListIds&quot;
          :selectedList=&quot;selectedList&quot;
          :isSelected=&quot;isSelected&quot;
        /&gt;
      &lt;/div&gt;
      &lt;div class=&quot;header-button-ri&quot; v-if=&quot;toolButton&quot;&gt;
        &lt;slot name=&quot;toolButton&quot;&gt;
          &lt;el-button :icon=&quot;Refresh&quot; circle @click=&quot;getTableList&quot; /&gt;
          &lt;el-button
            :icon=&quot;Printer&quot;
            circle
            v-if=&quot;columns.length&quot;
            @click=&quot;print&quot;
          /&gt;
          &lt;el-button
            :icon=&quot;Operation&quot;
            circle
            v-if=&quot;columns.length&quot;
            @click=&quot;openColSetting&quot;
          /&gt;
          &lt;el-button
            :icon=&quot;Search&quot;
            circle
            v-if=&quot;searchColumns.length&quot;
            @click=&quot;isShowSearch = !isShowSearch&quot;
          /&gt;
        &lt;/slot&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;!-- 表格主体 --&gt;
    &lt;el-table
      ref=&quot;tableRef&quot;
      v-bind=&quot;$attrs&quot;
      :data=&quot;data ?? tableData&quot;
      :border=&quot;border&quot;
      :row-key=&quot;rowKey&quot;
      @selection-change=&quot;selectionChange&quot;
    &gt;
      &lt;!-- 默认插槽 --&gt;
      &lt;slot&gt;&lt;/slot&gt;
      &lt;template v-for=&quot;item in tableColumns&quot; :key=&quot;item&quot;&gt;
        &lt;!-- selection || index || expand --&gt;
        &lt;el-table-column
          v-bind=&quot;item&quot;
          :align=&quot;item.align ?? &#39;center&#39;&quot;
          :reserve-selection=&quot;item.type == &#39;selection&#39;&quot;
          v-if=&quot;
            item.type &amp;&amp; [&#39;selection&#39;, &#39;index&#39;, &#39;expand&#39;].includes(item.type)
          &quot;
        &gt;
          &lt;template #default=&quot;scope&quot; v-if=&quot;item.type == &#39;expand&#39;&quot;&gt;
            &lt;component :is=&quot;item.render&quot; v-bind=&quot;scope&quot; v-if=&quot;item.render&quot;&gt;
            &lt;/component&gt;
            &lt;slot :name=&quot;item.type&quot; v-bind=&quot;scope&quot; v-else&gt;&lt;/slot&gt;
          &lt;/template&gt;
        &lt;/el-table-column&gt;
        &lt;!-- other --&gt;
        &lt;TableColumn
          v-if=&quot;!item.type &amp;&amp; item.prop &amp;&amp; item.isShow&quot;
          :column=&quot;item&quot;
        &gt;
          &lt;template v-for=&quot;slot in Object.keys($slots)&quot; #[slot]=&quot;scope&quot;&gt;
            &lt;slot :name=&quot;slot&quot; v-bind=&quot;scope&quot;&gt;&lt;/slot&gt;
          &lt;/template&gt;
        &lt;/TableColumn&gt;
      &lt;/template&gt;
      &lt;!-- 插入表格最后一行之后的插槽 --&gt;
      &lt;template #append&gt;
        &lt;slot name=&quot;append&quot;&gt; &lt;/slot&gt;
      &lt;/template&gt;
      &lt;!-- 无数据 --&gt;
      &lt;template #empty&gt;
        &lt;div class=&quot;table-empty&quot;&gt;
          &lt;slot name=&quot;empty&quot;&gt;
            &lt;img src=&quot;@/assets/images/notData.png&quot; alt=&quot;notData&quot; /&gt;
            &lt;div&gt;暂无数据&lt;/div&gt;
          &lt;/slot&gt;
        &lt;/div&gt;
      &lt;/template&gt;
    &lt;/el-table&gt;
    &lt;!-- 分页组件 --&gt;
    &lt;slot name=&quot;pagination&quot;&gt;
      &lt;Pagination
        v-if=&quot;pagination&quot;
        :pageable=&quot;pageable&quot;
        :handle-size-change=&quot;handleSizeChange&quot;
        :handle-current-change=&quot;handleCurrentChange&quot;
      /&gt;
    &lt;/slot&gt;
  &lt;/div&gt;
  &lt;!-- 列设置 --&gt;
  &lt;ColSetting v-if=&quot;toolButton&quot; ref=&quot;colRef&quot; v-model:col-setting=&quot;colSetting&quot; /&gt;
&lt;/template&gt;

&lt;script setup lang=&quot;ts&quot; name=&quot;ProTable&quot;&gt;
import &#123; ref, watch, computed, provide, onMounted &#125; from &quot;vue&quot;;
import &#123; ElTable &#125; from &quot;element-plus&quot;;
import &#123; useTable &#125; from &quot;@/hooks/useTable&quot;;
import &#123; useSelection &#125; from &quot;@/hooks/useSelection&quot;;
import &#123; BreakPoint &#125; from &quot;@/components/Grid/interface&quot;;
import &#123; ColumnProps &#125; from &quot;@/components/ProTable/interface&quot;;
import &#123; Refresh, Printer, Operation, Search &#125; from &quot;@element-plus/icons-vue&quot;;
import &#123;
  filterEnum,
  formatValue,
  handleProp,
  handleRowAccordingToProp,
&#125; from &quot;@/utils&quot;;
import SearchForm from &quot;@/components/SearchForm/index.vue&quot;;
import Pagination from &quot;./components/Pagination.vue&quot;;
import ColSetting from &quot;./components/ColSetting.vue&quot;;
import TableColumn from &quot;./components/TableColumn.vue&quot;;
import printJS from &quot;print-js&quot;;

export interface ProTableProps &#123;
  columns: ColumnProps[]; // 列配置项  ==&gt; 必传
  data?: any[]; // 静态 table data 数据，若存在则不会使用 requestApi 返回的 data ==&gt; 非必传
  requestApi?: (params: any) =&gt; Promise&lt;any&gt;; // 请求表格数据的 api ==&gt; 非必传
  requestAuto?: boolean; // 是否自动执行请求 api ==&gt; 非必传（默认为true）
  requestError?: (params: any) =&gt; void; // 表格 api 请求错误监听 ==&gt; 非必传
  dataCallback?: (data: any) =&gt; any; // 返回数据的回调函数，可以对数据进行处理 ==&gt; 非必传
  title?: string; // 表格标题，目前只在打印的时候用到 ==&gt; 非必传
  pagination?: boolean; // 是否需要分页组件 ==&gt; 非必传（默认为true）
  initParam?: any; // 初始化请求参数 ==&gt; 非必传（默认为&#123;&#125;）
  border?: boolean; // 是否带有纵向边框 ==&gt; 非必传（默认为true）
  toolButton?: boolean; // 是否显示表格功能按钮 ==&gt; 非必传（默认为true）
  rowKey?: string; // 行数据的 Key，用来优化 Table 的渲染，当表格数据多选时，所指定的 id ==&gt; 非必传（默认为 id）
  searchCol?: number | Record&lt;BreakPoint, number&gt;; // 表格搜索项 每列占比配置 ==&gt; 非必传 &#123; xs: 1, sm: 2, md: 2, lg: 3, xl: 4 &#125;
&#125;

// 接受父组件参数，配置默认值
const props = withDefaults(defineProps&lt;ProTableProps&gt;(), &#123;
  columns: () =&gt; [],
  requestAuto: true,
  pagination: true,
  initParam: &#123;&#125;,
  border: true,
  toolButton: true,
  rowKey: &quot;id&quot;,
  searchCol: () =&gt; (&#123; xs: 1, sm: 2, md: 2, lg: 3, xl: 4 &#125;),
&#125;);

// 是否显示搜索模块
const isShowSearch = ref(true);

// 表格 DOM 元素
const tableRef = ref&lt;InstanceType&lt;typeof ElTable&gt;&gt;();

// 表格多选 Hooks
const &#123; selectionChange, selectedList, selectedListIds, isSelected &#125; =
  useSelection(props.rowKey);

// 表格操作 Hooks
const &#123;
  tableData,
  pageable,
  searchParam,
  searchInitParam,
  getTableList,
  search,
  reset,
  handleSizeChange,
  handleCurrentChange,
&#125; = useTable(
  props.requestApi,
  props.initParam,
  props.pagination,
  props.dataCallback,
  props.requestError
);

// 清空选中数据列表
const clearSelection = () =&gt; tableRef.value!.clearSelection();

// 初始化请求
onMounted(() =&gt; props.requestAuto &amp;&amp; getTableList());

// 监听页面 initParam 改化，重新获取表格数据
watch(() =&gt; props.initParam, getTableList, &#123; deep: true &#125;);

// 接收 columns 并设置为响应式
const tableColumns = ref&lt;ColumnProps[]&gt;(props.columns);

// 定义 enumMap 存储 enum 值（避免异步请求无法格式化单元格内容 || 无法填充搜索下拉选择）
const enumMap = ref(new Map&lt;string, &#123; [key: string]: any &#125;[]&gt;());
provide(&quot;enumMap&quot;, enumMap);
const setEnumMap = async (col: ColumnProps) =&gt; &#123;
  if (!col.enum) return;
  // 如果当前 enum 为后台数据需要请求数据，则调用该请求接口，并存储到 enumMap
  if (typeof col.enum !== &quot;function&quot;)
    return enumMap.value.set(col.prop!, col.enum!);
  const &#123; data &#125; = await col.enum();
  enumMap.value.set(col.prop!, data);
&#125;;

// 扁平化 columns
const flatColumnsFunc = (
  columns: ColumnProps[],
  flatArr: ColumnProps[] = []
) =&gt; &#123;
  columns.forEach(async (col) =&gt; &#123;
    if (col._children?.length) flatArr.push(...flatColumnsFunc(col._children));
    flatArr.push(col);

    // 给每一项 column 添加 isShow &amp;&amp; isFilterEnum 默认属性
    col.isShow = col.isShow ?? true;
    col.isFilterEnum = col.isFilterEnum ?? true;

    // 设置 enumMap
    setEnumMap(col);
  &#125;);
  return flatArr.filter((item) =&gt; !item._children?.length);
&#125;;

// flatColumns
const flatColumns = ref&lt;ColumnProps[]&gt;();
flatColumns.value = flatColumnsFunc(tableColumns.value);

// 过滤需要搜索的配置项
const searchColumns = flatColumns.value.filter(
  (item) =&gt; item.search?.el || item.search?.render
);

// 设置搜索表单排序默认值 &amp;&amp; 设置搜索表单项的默认值
searchColumns.forEach((column, index) =&gt; &#123;
  column.search!.order = column.search!.order ?? index + 2;
  if (
    column.search?.defaultValue !== undefined &amp;&amp;
    column.search?.defaultValue !== null
  ) &#123;
    searchInitParam.value[column.search.key ?? handleProp(column.prop!)] =
      column.search?.defaultValue;
    searchParam.value[column.search.key ?? handleProp(column.prop!)] =
      column.search?.defaultValue;
  &#125;
&#125;);

// 排序搜索表单项
searchColumns.sort((a, b) =&gt; a.search!.order! - b.search!.order!);

// 列设置 ==&gt; 过滤掉不需要设置的列
const colRef = ref();
const colSetting = tableColumns.value!.filter(
  (item) =&gt;
    ![&quot;selection&quot;, &quot;index&quot;, &quot;expand&quot;].includes(item.type!) &amp;&amp;
    item.prop !== &quot;operation&quot; &amp;&amp;
    item.isShow
);
const openColSetting = () =&gt; colRef.value.openColSetting();

// 🙅‍♀️ 不需要打印可以把以下方法删除，打印功能目前存在很多 bug
// 处理打印数据（把后台返回的值根据 enum 做转换）
const printData = computed(() =&gt; &#123;
  const handleData = props.data ?? tableData.value;
  const printDataList = JSON.parse(
    JSON.stringify(selectedList.value.length ? selectedList.value : handleData)
  );
  // 找出需要转换数据的列（有 enum || 多级 prop &amp;&amp; 需要根据 enum 格式化）
  const needTransformCol = flatColumns.value!.filter(
    (item) =&gt;
      (item.enum || (item.prop &amp;&amp; item.prop.split(&quot;.&quot;).length &gt; 1)) &amp;&amp;
      item.isFilterEnum
  );
  needTransformCol.forEach((colItem) =&gt; &#123;
    printDataList.forEach((tableItem: &#123; [key: string]: any &#125;) =&gt; &#123;
      tableItem[handleProp(colItem.prop!)] =
        colItem.prop!.split(&quot;.&quot;).length &gt; 1 &amp;&amp; !colItem.enum
          ? formatValue(handleRowAccordingToProp(tableItem, colItem.prop!))
          : filterEnum(
              handleRowAccordingToProp(tableItem, colItem.prop!),
              enumMap.value.get(colItem.prop!),
              colItem.fieldNames
            );
      for (const key in tableItem) &#123;
        if (tableItem[key] === null)
          tableItem[key] = formatValue(tableItem[key]);
      &#125;
    &#125;);
  &#125;);
  return printDataList;
&#125;);

// 打印表格数据（💥 多级表头数据打印时，只能扁平化成一维数组，printJs 不支持多级表头打印）
const print = () =&gt; &#123;
  const header = `&lt;div style=&quot;text-align: center&quot;&gt;&lt;h2&gt;$&#123;props.title&#125;&lt;/h2&gt;&lt;/div&gt;`;
  const gridHeaderStyle =
    &quot;border: 1px solid #ebeef5;height: 45px;color: #232425;text-align: center;background-color: #fafafa;&quot;;
  const gridStyle =
    &quot;border: 1px solid #ebeef5;height: 40px;color: #494b4e;text-align: center&quot;;
  printJS(&#123;
    printable: printData.value,
    header: props.title &amp;&amp; header,
    properties: flatColumns
      .value!.filter(
        (item) =&gt;
          ![&quot;selection&quot;, &quot;index&quot;, &quot;expand&quot;].includes(item.type!) &amp;&amp;
          item.isShow &amp;&amp;
          item.prop !== &quot;operation&quot;
      )
      .map((item: ColumnProps) =&gt; (&#123;
        field: handleProp(item.prop!),
        displayName: item.label,
      &#125;)),
    type: &quot;json&quot;,
    gridHeaderStyle,
    gridStyle,
  &#125;);
&#125;;

// 暴露给父组件的参数和方法(外部需要什么，都可以从这里暴露出去)
defineExpose(&#123;
  element: tableRef,
  tableData,
  pageable,
  searchParam,
  searchInitParam,
  getTableList,
  search,
  reset,
  handleSizeChange,
  handleCurrentChange,
  clearSelection,
  enumMap,
  isSelected,
  selectedList,
  selectedListIds,
&#125;);
&lt;/script&gt;
</code></pre>
<h3 id="TableColumn-vue"><a href="#TableColumn-vue" class="headerlink" title="TableColumn.vue"></a>TableColumn.vue</h3><pre><code class="vue">&lt;template&gt;
  &lt;RenderTableColumn v-bind=&quot;column&quot; /&gt;
&lt;/template&gt;

&lt;script setup lang=&quot;tsx&quot; name=&quot;TableColumn&quot;&gt;
import &#123; inject, ref, useSlots &#125; from &quot;vue&quot;;
import &#123;
  ColumnProps,
  RenderScope,
  HeaderRenderScope,
&#125; from &quot;@/components/ProTable/interface&quot;;
import &#123;
  filterEnum,
  formatValue,
  handleProp,
  handleRowAccordingToProp,
&#125; from &quot;@/utils&quot;;

defineProps&lt;&#123; column: ColumnProps &#125;&gt;();

const slots = useSlots();

const enumMap = inject(&quot;enumMap&quot;, ref(new Map()));

// 渲染表格数据
const renderCellData = (item: ColumnProps, scope: RenderScope&lt;any&gt;) =&gt; &#123;
  return enumMap.value.get(item.prop) &amp;&amp; item.isFilterEnum
    ? filterEnum(
        handleRowAccordingToProp(scope.row, item.prop!),
        enumMap.value.get(item.prop)!,
        item.fieldNames
      )
    : formatValue(handleRowAccordingToProp(scope.row, item.prop!));
&#125;;

// 获取 tag 类型
const getTagType = (item: ColumnProps, scope: RenderScope&lt;any&gt;) =&gt; &#123;
  return filterEnum(
    handleRowAccordingToProp(scope.row, item.prop!),
    enumMap.value.get(item.prop),
    item.fieldNames,
    &quot;tag&quot;
  );
&#125;;

const RenderTableColumn = (item: ColumnProps) =&gt; &#123;
  return (
    &lt;&gt;
      &#123;item.isShow &amp;&amp; (
        &lt;el-table-column
          &#123;...item&#125;
          align=&#123;item.align ?? &quot;center&quot;&#125;
          showOverflowTooltip=&#123;
            item.showOverflowTooltip ?? item.prop !== &quot;operation&quot;
          &#125;
        &gt;
          &#123;&#123;
            default: (scope: RenderScope<any>) => &#123;
              if (item._children)
                return item._children.map((child) => RenderTableColumn(child));
              if (item.render) return item.render(scope);
              if (slots[handleProp(item.prop!)])
                return slots[handleProp(item.prop!)]!(scope);
              if (item.tag)
                return (
                  <el-tag type=&#123;getTagType(item, scope)&#125;>
                    &#123;renderCellData(item, scope)&#125;
                  </el-tag>
                );
              return renderCellData(item, scope);
            &#125;,
            header: (scope: HeaderRenderScope<any>) => &#123;
              if (item.headerRender) return item.headerRender(scope);
              if (slots[`$&#123;handleProp(item.prop!)&#125;Header`])
                return slots[`$&#123;handleProp(item.prop!)&#125;Header`]!(scope);
              return item.label;
            &#125;,
          &#125;&#125;
        &lt;/el-table-column&gt;
      )&#125;
    &lt;/&gt;
  );
&#125;;
&lt;/script&gt;
</code></pre>
<h3 id="使用-ProTable-组件"><a href="#使用-ProTable-组件" class="headerlink" title="使用 ProTable 组件"></a>使用 ProTable 组件</h3><pre><code class="vue">&lt;template&gt;
  &lt;div class=&quot;table-box&quot;&gt;
    &lt;ProTable
      ref=&quot;proTable&quot;
      title=&quot;用户列表&quot;
      :columns=&quot;columns&quot;
      :request-api=&quot;getTableList&quot;
      :init-param=&quot;initParam&quot;
      :data-callback=&quot;dataCallback&quot;
    &gt;
      &lt;!-- 表格 header 按钮 --&gt;
      &lt;template #tableHeader=&quot;scope&quot;&gt;
        &lt;el-button
          type=&quot;primary&quot;
          :icon=&quot;CirclePlus&quot;
          @click=&quot;openDrawer(&#39;新增&#39;)&quot;
          v-auth=&quot;&#39;add&#39;&quot;
          &gt;新增用户&lt;/el-button
        &gt;
        &lt;el-button
          type=&quot;primary&quot;
          :icon=&quot;Upload&quot;
          plain
          @click=&quot;batchAdd&quot;
          v-auth=&quot;&#39;batchAdd&#39;&quot;
          &gt;批量添加用户&lt;/el-button
        &gt;
        &lt;el-button
          type=&quot;primary&quot;
          :icon=&quot;Download&quot;
          plain
          @click=&quot;downloadFile&quot;
          v-auth=&quot;&#39;export&#39;&quot;
          &gt;导出用户数据&lt;/el-button
        &gt;
        &lt;el-button type=&quot;primary&quot; plain @click=&quot;toDetail&quot;
          &gt;To 子集详情页面&lt;/el-button
        &gt;
        &lt;el-button
          type=&quot;danger&quot;
          :icon=&quot;Delete&quot;
          plain
          @click=&quot;batchDelete(scope.selectedListIds)&quot;
          :disabled=&quot;!scope.isSelected&quot;
        &gt;
          批量删除用户
        &lt;/el-button&gt;
      &lt;/template&gt;
      &lt;!-- Expand --&gt;
      &lt;template #expand=&quot;scope&quot;&gt;
        &#123;&#123; scope.row &#125;&#125;
      &lt;/template&gt;
      &lt;!-- usernameHeader --&gt;
      &lt;template #usernameHeader=&quot;scope&quot;&gt;
        &lt;el-button
          type=&quot;primary&quot;
          @click=&quot;ElMessage.success(&#39;我是通过作用域插槽渲染的表头&#39;)&quot;
        &gt;
          &#123;&#123; scope.column.label &#125;&#125;
        &lt;/el-button&gt;
      &lt;/template&gt;
      &lt;!-- createTime --&gt;
      &lt;template #createTime=&quot;scope&quot;&gt;
        &lt;el-button
          type=&quot;primary&quot;
          link
          @click=&quot;ElMessage.success(&#39;我是通过作用域插槽渲染的内容&#39;)&quot;
        &gt;
          &#123;&#123; scope.row.createTime &#125;&#125;
        &lt;/el-button&gt;
      &lt;/template&gt;
      &lt;!-- 表格操作 --&gt;
      &lt;template #operation=&quot;scope&quot;&gt;
        &lt;el-button
          type=&quot;primary&quot;
          link
          :icon=&quot;View&quot;
          @click=&quot;openDrawer(&#39;查看&#39;, scope.row)&quot;
          &gt;查看&lt;/el-button
        &gt;
        &lt;el-button
          type=&quot;primary&quot;
          link
          :icon=&quot;EditPen&quot;
          @click=&quot;openDrawer(&#39;编辑&#39;, scope.row)&quot;
          &gt;编辑&lt;/el-button
        &gt;
        &lt;el-button
          type=&quot;primary&quot;
          link
          :icon=&quot;Refresh&quot;
          @click=&quot;resetPass(scope.row)&quot;
          &gt;重置密码&lt;/el-button
        &gt;
        &lt;el-button
          type=&quot;primary&quot;
          link
          :icon=&quot;Delete&quot;
          @click=&quot;deleteAccount(scope.row)&quot;
          &gt;删除&lt;/el-button
        &gt;
      &lt;/template&gt;
    &lt;/ProTable&gt;
    &lt;UserDrawer ref=&quot;drawerRef&quot; /&gt;
    &lt;ImportExcel ref=&quot;dialogRef&quot; /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang=&quot;tsx&quot; name=&quot;useProTable&quot;&gt;
import &#123; ref, reactive &#125; from &quot;vue&quot;;
import &#123; useRouter &#125; from &quot;vue-router&quot;;
import &#123; User &#125; from &quot;@/api/interface&quot;;
import &#123; useHandleData &#125; from &quot;@/hooks/useHandleData&quot;;
import &#123; useDownload &#125; from &quot;@/hooks/useDownload&quot;;
import &#123; useAuthButtons &#125; from &quot;@/hooks/useAuthButtons&quot;;
import &#123; ElMessage, ElMessageBox &#125; from &quot;element-plus&quot;;
import ProTable from &quot;@/components/ProTable/index.vue&quot;;
import ImportExcel from &quot;@/components/ImportExcel/index.vue&quot;;
import UserDrawer from &quot;@/views/proTable/components/UserDrawer.vue&quot;;
import &#123;
  ProTableInstance,
  ColumnProps,
  HeaderRenderScope,
&#125; from &quot;@/components/ProTable/interface&quot;;
import &#123;
  CirclePlus,
  Delete,
  EditPen,
  Download,
  Upload,
  View,
  Refresh,
&#125; from &quot;@element-plus/icons-vue&quot;;
import &#123;
  getUserList,
  deleteUser,
  editUser,
  addUser,
  changeUserStatus,
  resetUserPassWord,
  exportUserInfo,
  BatchAddUser,
  getUserStatus,
  getUserGender,
&#125; from &quot;@/api/modules/user&quot;;

const router = useRouter();

// 跳转详情页
const toDetail = () =&gt; &#123;
  router.push(
    `/proTable/useProTable/detail/$&#123;Math.random().toFixed(
      3
    )&#125;?params=detail-page`
  );
&#125;;

// 获取 ProTable 元素，调用其获取刷新数据方法（还能获取到当前查询参数，方便导出携带参数）
const proTable = ref&lt;ProTableInstance&gt;();

// 如果表格需要初始化请求参数，直接定义传给 ProTable(之后每次请求都会自动带上该参数，此参数更改之后也会一直带上，改变此参数会自动刷新表格数据)
const initParam = reactive(&#123; type: 1 &#125;);

// dataCallback 是对于返回的表格数据做处理，如果你后台返回的数据不是 list &amp;&amp; total &amp;&amp; pageNum &amp;&amp; pageSize 这些字段，那么你可以在这里进行处理成这些字段
// 或者直接去 hooks/useTable.ts 文件中把字段改为你后端对应的就行
const dataCallback = (data: any) =&gt; &#123;
  return &#123;
    list: data.list,
    total: data.total,
    pageNum: data.pageNum,
    pageSize: data.pageSize,
  &#125;;
&#125;;

// 如果你想在请求之前对当前请求参数做一些操作，可以自定义如下函数：params 为当前所有的请求参数（包括分页），最后返回请求列表接口
// 默认不做操作就直接在 ProTable 组件上绑定	:requestApi=&quot;getUserList&quot;
const getTableList = (params: any) =&gt; &#123;
  let newParams = JSON.parse(JSON.stringify(params));
  newParams.createTime &amp;&amp; (newParams.startTime = newParams.createTime[0]);
  newParams.createTime &amp;&amp; (newParams.endTime = newParams.createTime[1]);
  delete newParams.createTime;
  return getUserList(newParams);
&#125;;

// 页面按钮权限（按钮权限既可以使用 hooks，也可以直接使用 v-auth 指令，指令适合直接绑定在按钮上，hooks 适合根据按钮权限显示不同的内容）
const &#123; BUTTONS &#125; = useAuthButtons();

// 自定义渲染表头（使用tsx语法）
const headerRender = (scope: HeaderRenderScope&lt;User.ResUserList&gt;) =&gt; &#123;
  return (
    &lt;el-button
      type=&quot;primary&quot;
      onClick=&#123;() =&gt; ElMessage.success(&quot;我是通过 tsx 语法渲染的表头&quot;)&#125;
    &gt;
      &#123;scope.column.label&#125;
    &lt;/el-button&gt;
  );
&#125;;

// 表格配置项
const columns: ColumnProps&lt;User.ResUserList&gt;[] = [
  &#123; type: &quot;selection&quot;, fixed: &quot;left&quot;, width: 80 &#125;,
  &#123; type: &quot;index&quot;, label: &quot;#&quot;, width: 80 &#125;,
  &#123; type: &quot;expand&quot;, label: &quot;Expand&quot;, width: 100 &#125;,
  &#123;
    prop: &quot;username&quot;,
    label: &quot;用户姓名&quot;,
    search: &#123; el: &quot;input&quot; &#125;,
    render: (scope) =&gt; &#123;
      return (
        &lt;el-button
          type=&quot;primary&quot;
          link
          onClick=&#123;() =&gt; ElMessage.success(&quot;我是通过 tsx 语法渲染的内容&quot;)&#125;
        &gt;
          &#123;scope.row.username&#125;
        &lt;/el-button&gt;
      );
    &#125;,
  &#125;,
  &#123;
    prop: &quot;gender&quot;,
    label: &quot;性别&quot;,
    // 字典数据
    // enum: genderType,
    // 字典请求不带参数
    enum: getUserGender,
    // 字典请求携带参数
    // enum: () =&gt; getUserGender(&#123; id: 1 &#125;),
    search: &#123; el: &quot;select&quot;, props: &#123; filterable: true &#125; &#125;,
    fieldNames: &#123; label: &quot;genderLabel&quot;, value: &quot;genderValue&quot; &#125;,
  &#125;,
  &#123;
    // 多级 prop
    prop: &quot;user.detail.age&quot;,
    label: &quot;年龄&quot;,
    search: &#123;
      // 自定义 search 显示内容
      render: (&#123; searchParam &#125;) =&gt; &#123;
        return (
          &lt;div class=&quot;flx-center&quot;&gt;
            &lt;el-input vModel_trim=&#123;searchParam.minAge&#125; placeholder=&quot;最小年龄&quot; /&gt;
            &lt;span class=&quot;mr10 ml10&quot;&gt;-&lt;/span&gt;
            &lt;el-input vModel_trim=&#123;searchParam.maxAge&#125; placeholder=&quot;最大年龄&quot; /&gt;
          &lt;/div&gt;
        );
      &#125;,
    &#125;,
  &#125;,
  &#123; prop: &quot;idCard&quot;, label: &quot;身份证号&quot;, search: &#123; el: &quot;input&quot; &#125; &#125;,
  &#123; prop: &quot;email&quot;, label: &quot;邮箱&quot; &#125;,
  &#123; prop: &quot;address&quot;, label: &quot;居住地址&quot; &#125;,
  &#123;
    prop: &quot;status&quot;,
    label: &quot;用户状态&quot;,
    enum: getUserStatus,
    search: &#123; el: &quot;tree-select&quot;, props: &#123; filterable: true &#125; &#125;,
    fieldNames: &#123; label: &quot;userLabel&quot;, value: &quot;userStatus&quot; &#125;,
    render: (scope) =&gt; &#123;
      return (
        &lt;&gt;
          &#123;BUTTONS.value.status ? (
            &lt;el-switch
              model-value=&#123;scope.row.status&#125;
              active-text=&#123;scope.row.status ? &quot;启用&quot; : &quot;禁用&quot;&#125;
              active-value=&#123;1&#125;
              inactive-value=&#123;0&#125;
              onClick=&#123;() =&gt; changeStatus(scope.row)&#125;
            /&gt;
          ) : (
            &lt;el-tag type=&#123;scope.row.status ? &quot;success&quot; : &quot;danger&quot;&#125;&gt;
              &#123;scope.row.status ? &quot;启用&quot; : &quot;禁用&quot;&#125;
            &lt;/el-tag&gt;
          )&#125;
        &lt;/&gt;
      );
    &#125;,
  &#125;,
  &#123;
    prop: &quot;createTime&quot;,
    label: &quot;创建时间&quot;,
    headerRender,
    width: 180,
    search: &#123;
      el: &quot;date-picker&quot;,
      span: 2,
      props: &#123; type: &quot;datetimerange&quot;, valueFormat: &quot;YYYY-MM-DD HH:mm:ss&quot; &#125;,
      defaultValue: [&quot;2022-11-12 11:35:00&quot;, &quot;2022-12-12 11:35:00&quot;],
    &#125;,
  &#125;,
  &#123; prop: &quot;operation&quot;, label: &quot;操作&quot;, fixed: &quot;right&quot;, width: 330 &#125;,
];

// 删除用户信息
const deleteAccount = async (params: User.ResUserList) =&gt; &#123;
  await useHandleData(
    deleteUser,
    &#123; id: [params.id] &#125;,
    `删除【$&#123;params.username&#125;】用户`
  );
  proTable.value?.getTableList();
&#125;;

// 批量删除用户信息
const batchDelete = async (id: string[]) =&gt; &#123;
  await useHandleData(deleteUser, &#123; id &#125;, &quot;删除所选用户信息&quot;);
  proTable.value?.clearSelection();
  proTable.value?.getTableList();
&#125;;

// 重置用户密码
const resetPass = async (params: User.ResUserList) =&gt; &#123;
  await useHandleData(
    resetUserPassWord,
    &#123; id: params.id &#125;,
    `重置【$&#123;params.username&#125;】用户密码`
  );
  proTable.value?.getTableList();
&#125;;

// 切换用户状态
const changeStatus = async (row: User.ResUserList) =&gt; &#123;
  await useHandleData(
    changeUserStatus,
    &#123; id: row.id, status: row.status == 1 ? 0 : 1 &#125;,
    `切换【$&#123;row.username&#125;】用户状态`
  );
  proTable.value?.getTableList();
&#125;;

// 导出用户列表
const downloadFile = async () =&gt; &#123;
  ElMessageBox.confirm(&quot;确认导出用户数据?&quot;, &quot;温馨提示&quot;, &#123;
    type: &quot;warning&quot;,
  &#125;).then(() =&gt;
    useDownload(exportUserInfo, &quot;用户列表&quot;, proTable.value?.searchParam)
  );
&#125;;

// 批量添加用户
const dialogRef = ref&lt;InstanceType&lt;typeof ImportExcel&gt; | null&gt;(null);
const batchAdd = () =&gt; &#123;
  const params = &#123;
    title: &quot;用户&quot;,
    tempApi: exportUserInfo,
    importApi: BatchAddUser,
    getTableList: proTable.value?.getTableList,
  &#125;;
  dialogRef.value?.acceptParams(params);
&#125;;

// 打开 drawer(新增、查看、编辑)
const drawerRef = ref&lt;InstanceType&lt;typeof UserDrawer&gt; | null&gt;(null);
const openDrawer = (title: string, row: Partial&lt;User.ResUserList&gt; = &#123;&#125;) =&gt; &#123;
  const params = &#123;
    title,
    isView: title === &quot;查看&quot;,
    row: &#123; ...row &#125;,
    api: title === &quot;新增&quot; ? addUser : title === &quot;编辑&quot; ? editUser : undefined,
    getTableList: proTable.value?.getTableList,
  &#125;;
  drawerRef.value?.acceptParams(params);
&#125;;
&lt;/script&gt;
</code></pre>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2023/02/18/122-vue/" title="122、《Vuejs设计与实现》- 霍春阳：运行时和编译时(一)"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: 122、《Vuejs设计与实现》- 霍春阳：运行时和编译时(一)</span></a><a class="button is-default" href="/2023/02/03/120-github/" title="120、git提交代码终端出现“Enter passphrase for key ‘/Users/yq/.ssh/id_rsa”"><span class="has-text-weight-semibold">下一页: 120、git提交代码终端出现“Enter passphrase for key ‘/Users/yq/.ssh/id_rsa”</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/Jude"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><a title="zhihu" target="_blank" rel="noopener nofollow" href="//zhihu.com/https://www.zhihu.com/hot"><i class="iconfont icon-zhihu"></i></a><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> Jude 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span>记住昨日的美好，过好今日的生活，憧憬明天的到来</span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>