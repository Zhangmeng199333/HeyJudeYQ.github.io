<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<meta name="hexo-config" content="{&quot;hostname&quot;:&quot;issummer.cn&quot;,&quot;root&quot;:&quot;/&quot;,&quot;images&quot;:&quot;/images&quot;,&quot;scheme&quot;:&quot;Muse&quot;,&quot;version&quot;:&quot;8.3.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;}}">
<meta name="description" content="一、egg-jwt实现用户鉴权 用户鉴权，一种用于在通信网络中对试图访问来自服务提供商的服务的用户进行鉴权的方法。用于用户登陆到DSMP或使用数据业务时，业务网关或Portal发送此消息到DSMP，对该用户使用数据业务的合法性和有效性（状态是否为激活）进行检查。  简单理解，鉴权就是用户在浏览网页或 App 时，通过约定好的方式，让网页和用户建立起一种相互信赖的机制，继而返回给用户需要的信息。">
<meta property="og:type" content="article">
<meta property="og:title" content="83、egg-jwt用户鉴权、注册、登录及中间件">
<meta property="og:url" content="http://issummer.cn/2022/08/03/83-egg-jwt/index.html">
<meta property="og:site_name" content="Jude">
<meta property="og:description" content="一、egg-jwt实现用户鉴权 用户鉴权，一种用于在通信网络中对试图访问来自服务提供商的服务的用户进行鉴权的方法。用于用户登陆到DSMP或使用数据业务时，业务网关或Portal发送此消息到DSMP，对该用户使用数据业务的合法性和有效性（状态是否为激活）进行检查。  简单理解，鉴权就是用户在浏览网页或 App 时，通过约定好的方式，让网页和用户建立起一种相互信赖的机制，继而返回给用户需要的信息。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-03T14:00:00.000Z">
<meta property="article:modified_time" content="2022-10-11T08:57:11.946Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="egg">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://issummer.cn/2022/08/03/83-egg-jwt/">



<meta name="hexo-config-page" content="{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;}">
<meta name="hexo-config-calendar" content="">
<title>83、egg-jwt用户鉴权、注册、登录及中间件 | Jude</title><script data-pjax src="/js/load-config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Jude</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81egg-jwt%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E9%89%B4%E6%9D%83"><span class="nav-number">1.</span> <span class="nav-text">一、egg-jwt实现用户鉴权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.</span> <span class="nav-text">二、注册接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3"><span class="nav-number">3.</span> <span class="nav-text">三、登录接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">4.</span> <span class="nav-text">四、登录验证中间件</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">126</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://issummer.cn/2022/08/03/83-egg-jwt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jude">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          83、egg-jwt用户鉴权、注册、登录及中间件
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-08-03 22:00:00" itemprop="dateCreated datePublished" datetime="2022-08-03T22:00:00+08:00">2022-08-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-11 16:57:11" itemprop="dateModified" datetime="2022-10-11T16:57:11+08:00">2022-10-11</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <span id="more"></span>

<h2 id="一、egg-jwt实现用户鉴权"><a href="#一、egg-jwt实现用户鉴权" class="headerlink" title="一、egg-jwt实现用户鉴权"></a>一、egg-jwt实现用户鉴权</h2><blockquote>
<p>用户鉴权，一种用于在通信网络中对试图访问来自服务提供商的服务的用户进行鉴权的方法。用于用户登陆到DSMP或使用数据业务时，业务网关或Portal发送此消息到DSMP，对该用户使用数据业务的合法性和有效性（状态是否为激活）进行检查。</p>
</blockquote>
<p>简单理解，鉴权就是用户在浏览网页或 <code>App</code> 时，通过约定好的方式，让网页和用户建立起一种相互信赖的机制，继而返回给用户需要的信息。</p>
<p>鉴权的机制：</p>
<ul>
<li>HTTP Basic Authentication</li>
<li>session-cookie</li>
<li>Token 令牌</li>
<li>OAuth(开放授权)</li>
</ul>
<p><code>token</code> 可以运用在如网页、客户端、小程序、浏览器插件等等领域。如果选用 <code>cookie</code> 的形式鉴权，在客户端和小程序就无法使用这套接口，因为它们没有域的概念，而 <code>cookie</code> 是需要存在某个域下。</p>
<h2 id="二、注册接口"><a href="#二、注册接口" class="headerlink" title="二、注册接口"></a>二、注册接口</h2><p>在 <code>controller</code> 目录下新建 <code>user.js</code> 用于编写用户相关的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// controller/user.js</span><br><span class="hljs-meta">&#x27;use strict&#x27;</span>;<br><br><span class="hljs-keyword">const</span> Controller = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>).Controller;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span> </span>&#123;<br>  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">register</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; ctx &#125; = <span class="hljs-built_in">this</span>;<br>    <span class="hljs-keyword">const</span> &#123; username, password &#125; = ctx.request.body; <span class="hljs-comment">// 获取注册需要的参数</span><br>  &#125;<br>&#125;<br><br><span class="hljs-built_in">module</span>.exports = UserController;<br></code></pre></td></tr></table></figure>

<p>此时我们拿到了 <code>username</code> 和 <code>password</code>，我们需要判断两个参数是否为空。如果是空，则返回错误信息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 判空操作</span><br><span class="hljs-keyword">if</span> (!username || !password) &#123;<br>  ctx.body = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;账号密码不能为空&#x27;</span>,<br>    <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span><br>  &#125;<br>  <span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>此时我们还需要一个判断，根据用户传入的 <code>username</code> 去数据库的 <code>user</code> 表查询，是否已经被注册。</p>
<p>在 <code>service</code> 目录下新建 <code>user.js</code>，并且添加 <code>getUserByName</code> 方法用于根据 <code>username</code> 查找用户信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//  service/user.js</span><br><span class="hljs-meta">&#x27;use strict&#x27;</span>;<br><br><span class="hljs-keyword">const</span> Service = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;egg&#x27;</span>).Service;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Service</span> </span>&#123;<br>  <span class="hljs-comment">// 通过用户名获取用户信息</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">getUserByName</span>(<span class="hljs-params">username</span>)</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; app &#125; = <span class="hljs-built_in">this</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> app.mysql.get(<span class="hljs-string">&#x27;user&#x27;</span>, &#123; username &#125;);<br>        <span class="hljs-keyword">return</span> result;<br>      &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        <span class="hljs-built_in">console</span>.log(error);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>  &#125;<br>&#125;<br><span class="hljs-built_in">module</span>.exports = UserService;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>使用 async 和 await 时，如果想捕获错误，需要使用 try…catch 来捕获，如果代码运行过程中发生错误，都将会被 catch 捕获。</p>
</blockquote>
<p> <code>controller/user.js</code> 继续添加逻辑，在 「判空操作」逻辑下，判断是否已经被注册的逻辑：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// controller/user.js</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">register</span>(<span class="hljs-params"></span>)</span> &#123;<br>  ...<br>  <span class="hljs-comment">// 验证数据库内是否已经有该账户名</span><br>  <span class="hljs-keyword">const</span> userInfo = <span class="hljs-keyword">await</span> ctx.service.user.getUserByName(username) <span class="hljs-comment">// 获取用户信息</span><br><br>  <span class="hljs-comment">// 判断是否已经存在</span><br>  <span class="hljs-keyword">if</span> (userInfo &amp;&amp; userInfo.id) &#123;<br>    ctx.body = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;账户名已被注册，请重新输入&#x27;</span>,<br>      <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span><br>    &#125;<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>经过上述两层判断之后，接下便可将账号和密码写入数据库</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// controller/user.js</span><br><span class="hljs-comment">// 默认头像，放在 user.js 的最外，部避免重复声明。</span><br><span class="hljs-keyword">const</span> defaultAvatar = <span class="hljs-string">&#x27;http://s.yezgea02.com/1615973940679/WeChat77d6d2ac093e247c361f0b8a7aeb6c2a.png&#x27;</span><br><span class="hljs-comment">// 调用 service 方法，将数据存入数据库。</span><br><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> ctx.service.user.register(&#123;<br>  username,<br>  password,<br>  <span class="hljs-attr">signature</span>: <span class="hljs-string">&#x27;世界和平。&#x27;</span>,<br>  <span class="hljs-attr">avatar</span>: defaultAvatar<br>&#125;);<br><br><span class="hljs-keyword">if</span> (result) &#123;<br>  ctx.body = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;注册成功&#x27;</span>,<br>    <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span><br>  &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  ctx.body = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;注册失败&#x27;</span>,<br>    <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>service/user.js</code> 添加 <code>register</code> 写入数据库的方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// service/user.js</span><br>...<br><span class="hljs-comment">// 注册</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">register</span>(<span class="hljs-params">params</span>)</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; app &#125; = <span class="hljs-built_in">this</span>;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> app.mysql.insert(<span class="hljs-string">&#x27;user&#x27;</span>, params);<br>    <span class="hljs-keyword">return</span> result;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-built_in">console</span>.log(error);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在 <code>router.js</code> 将接口抛出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// router.js</span><br><span class="hljs-meta">&#x27;use strict&#x27;</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;Egg.Application&#125;</span> <span class="hljs-variable">app</span></span> - egg application</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; router, controller &#125; = app;<br>  router.post(<span class="hljs-string">&#x27;/api/user/register&#x27;</span>, controller.user.register);<br>&#125;;<br></code></pre></td></tr></table></figure>



<p>通过postman工具测试接口。</p>
<h2 id="三、登录接口"><a href="#三、登录接口" class="headerlink" title="三、登录接口"></a>三、登录接口</h2><blockquote>
<p>通过注册的「用户名」和「密码」，调用登录接口，接口会返回给我们一个 <code>token</code> 令牌</p>
</blockquote>
<p>每次发起请求，无论是获取数据，还是提交数据，我们都需要将 <code>token</code> 带上，以此来标识，此次获取(GET)或提交(POST)是哪一个用户的行为。</p>
<p> <code>egg-jwt</code> 有加密的功能，也有解密的功能。通过解密 <code>token</code> 拿到当初加密 <code>token</code> 时的信息，信息的内容大致就是当初注册时候的用户信息。</p>
<p>安装egg-jwt插件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm i egg-jwt -S<br></code></pre></td></tr></table></figure>

<p>Egg-jwt的<a href="https://link.juejin.cn/?target=https://github.com/okoala/egg-jwt%23readme">仓库地址</a></p>
<p>在 <code>config/plugin.js</code> 下添加插件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js">jwt: &#123;<br>  <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">package</span>: <span class="hljs-string">&#x27;egg-jwt&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>config/config.default.js</code> 下添加自定义加密字符串</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">config.jwt = &#123;<br>  <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;YQ&#x27;</span>,<br>&#125;;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>secret<code>加密字符串，将在后续用于结合用户信息生成一串</code>token</p>
</blockquote>
<p>在 <code>/controller/user.js</code> 下新建 <code>login</code> 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">login</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-comment">// app 为全局属性，相当于所有的插件方法都植入到了 app 对象。</span><br>    <span class="hljs-keyword">const</span> &#123; ctx, app &#125; = <span class="hljs-built_in">this</span>;<br>    <span class="hljs-keyword">const</span> &#123; username, password &#125; = ctx.request.body<br>    <span class="hljs-comment">// 根据用户名，在数据库查找相对应的id操作</span><br>    <span class="hljs-keyword">const</span> userInfo = <span class="hljs-keyword">await</span> ctx.service.user.getUserByName(username)<br>    <span class="hljs-comment">// 没找到说明没有该用户</span><br>    <span class="hljs-keyword">if</span> (!userInfo || !userInfo.id) &#123;<br>      ctx.body = &#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>        <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;账号不存在&#x27;</span>,<br>        <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span><br>      &#125;<br>      <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">// 找到用户，并且判断输入密码与数据库中用户密码。</span><br>    <span class="hljs-keyword">if</span> (userInfo &amp;&amp; password != userInfo.password) &#123;<br>      ctx.body = &#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>        <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;账号密码错误&#x27;</span>,<br>        <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span><br>      &#125;<br>      <span class="hljs-keyword">return</span><br>    &#125;<br>  	 <span class="hljs-comment">// 生成 token 加盐</span><br>  	<span class="hljs-comment">// app.jwt.sign 方法接受两个参数，第一个为对象，对象内是需要加密的内容；第二个是加密字符串，上文已经提到过。</span><br>    <span class="hljs-keyword">const</span> token = app.jwt.sign(&#123;<br>      <span class="hljs-attr">id</span>: userInfo.id,<br>      <span class="hljs-attr">username</span>: userInfo.username,<br>      <span class="hljs-attr">exp</span>: <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Date</span>.now() / <span class="hljs-number">1000</span>) + (<span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>) <span class="hljs-comment">// token 有效期为 24 小时</span><br>    &#125;, app.config.jwt.secret);<br><br>    ctx.body = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>      <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;登录成功&#x27;</span>,<br>      <span class="hljs-attr">data</span>: &#123;<br>        token<br>      &#125;,<br>    &#125;;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>把获取到的 <code>userInfo</code> 中的 <code>id</code> 和 <code>username</code> 两个属性，通过 <code>app.jwt.sign</code> 方法，结合 <code>app.config.jwt.secret</code> 加密字符串（之前声明的 <code>YQ</code>），生成一个 <code>token</code>。这个 <code>token</code> 会是一串很长的加密字符串</p>
<p>在 <code>/controller/user.js</code> 中，新增一个验证方法 <code>test</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 验证方法</span><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; ctx, app &#125; = <span class="hljs-built_in">this</span>;<br>  <span class="hljs-comment">// 通过 token 解析，拿到 user_id</span><br>  <span class="hljs-keyword">const</span> token = ctx.request.header.authorization; <span class="hljs-comment">// 请求头获取 authorization 属性，值为 token</span><br>  <span class="hljs-comment">// 通过 app.jwt.verify + 加密字符串 解析出 token 的值 </span><br>  <span class="hljs-keyword">const</span> decode = <span class="hljs-keyword">await</span> app.jwt.verify(token, app.config.jwt.secret);<br>  <span class="hljs-comment">// 响应接口</span><br>  ctx.body = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;获取成功&#x27;</span>,<br>    <span class="hljs-attr">data</span>: &#123;<br>      ...decode<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>在路由 <code>router.js</code> 脚本中，将登录接口抛出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JS"><span class="hljs-meta">&#x27;use strict&#x27;</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;Egg.Application&#125;</span> <span class="hljs-variable">app</span></span> - egg application</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; router, controller &#125; = app;<br>  router.post(<span class="hljs-string">&#x27;/api/user/register&#x27;</span>, controller.user.register);<br>  router.post(<span class="hljs-string">&#x27;/api/user/login&#x27;</span>, controller.user.login);<br>&#125;;<br></code></pre></td></tr></table></figure>



<h2 id="四、登录验证中间件"><a href="#四、登录验证中间件" class="headerlink" title="四、登录验证中间件"></a>四、登录验证中间件</h2><p>中间件我们可以理解成一个过滤器，举个例子，我们有 <code>A</code>、<code>B</code>、<code>C</code>、<code>D</code> 四个接口是需要用户权限的，如果我们要判断是否有用户权限的话，就需要在这四个接口的控制层去判断用户是否登录。</p>
<p>每个接口都验证存在的弊端</p>
<blockquote>
<p>1、每次编写新的接口，都要在方法内部做判断，这很费事。 2、一旦鉴权有所调整，我们需要修改每个用到判断登录的代码。</p>
</blockquote>
<p>在请求接口的时候，过一层中间件，判断该请求是否是登录状态下发起的。此时我们打开项目，在 <code>app</code> 目录下新新建一个文件夹 <code>middleware</code>，并且在该目录下新增 <code>jwtErr.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-meta">&#x27;use strict&#x27;</span>;<br><br><span class="hljs-built_in">module</span>.exports = <span class="hljs-function">(<span class="hljs-params">secret</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">jwtErr</span>(<span class="hljs-params">ctx, next</span>) </span>&#123;<br>    <span class="hljs-keyword">const</span> token = ctx.request.header.authorization; <span class="hljs-comment">// 若是没有 token，返回的是 null 字符串</span><br>    <span class="hljs-keyword">let</span> decode<br>    <span class="hljs-keyword">if</span>(token != <span class="hljs-string">&#x27;null&#x27;</span> &amp;&amp; token) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        decode = ctx.app.jwt.verify(token, secret); <span class="hljs-comment">// 验证token</span><br>        <span class="hljs-keyword">await</span> next();<br>      &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;error&#x27;</span>, error)<br>        ctx.status = <span class="hljs-number">200</span>;<br>        ctx.body = &#123;<br>          <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;token已过期，请重新登录&#x27;</span>,<br>          <span class="hljs-attr">code</span>: <span class="hljs-number">401</span>,<br>        &#125;<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      ctx.status = <span class="hljs-number">200</span>;<br>      ctx.body = &#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">401</span>,<br>        <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;token不存在&#x27;</span>,<br>      &#125;;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>首先中间件默认抛出一个函数，该函数返回一个异步方法 <code>jwtErr</code>，<code>jewErr</code> 方法有两个参数 <code>ctx</code> 是上下文，可以在 <code>ctx</code> 中拿到全局对象 <code>app</code>。</p>
<p>首先，通过 <code>ctx.request.header.authorization</code> 获取到请求头中的 <code>authorization</code> 属性，它便是我们请求接口是携带的 <code>token</code> 值，如果没有携带 <code>token</code>，该值为字符串 <code>null</code>。我们通过 <code>if</code> 语句判断如果有 <code>token</code> 的情况下，使用 <code>ctx.app.jwt.verify</code> 方法验证该 <code>token</code> 是否存在并且有效，如果是存在且有效，则通过验证 <code>await next()</code> 继续执行后续的接口逻辑。否则判断是失效还是不存在该 <code>token</code>。</p>
<p>中间件完成后，我们在路由中<code>router.js</code> 去使用它</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-meta">&#x27;use strict&#x27;</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;Egg.Application&#125;</span> <span class="hljs-variable">app</span></span> - egg application</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; router, controller, middleware &#125; = app;<br>  <span class="hljs-keyword">const</span> _jwt = middleware.jwtErr(app.config.jwt.secret); <span class="hljs-comment">// 传入加密字符串</span><br>  router.post(<span class="hljs-string">&#x27;/api/user/register&#x27;</span>, controller.user.register);<br>  router.post(<span class="hljs-string">&#x27;/api/user/login&#x27;</span>, controller.user.login);<br>  router.get(<span class="hljs-string">&#x27;/api/user/test&#x27;</span>, _jwt, controller.user.test); <span class="hljs-comment">// 放入第二个参数，作为中间件过滤项</span><br>&#125;;<br></code></pre></td></tr></table></figure>


















    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/egg/" rel="tag"># egg</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/08/03/82-egg-mysql/" rel="prev" title="82、egg-mysql的增删改查">
                  <i class="fa fa-chevron-left"></i> 82、egg-mysql的增删改查
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/08/04/84.search/" rel="next" title="84、Chrome快速切换搜索引擎">
                  84、Chrome快速切换搜索引擎 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>





<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
